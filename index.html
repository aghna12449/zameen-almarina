<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <title>AL MARINA</title>

</head>

<body>
  <meta name="viewport"
    content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta http-equiv="x-ua-compatible" content="IE=edge" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" />
  <!-- adding style sheet -->
  <link rel="stylesheet" href="index.css" />
  <!-- Add Material-UI (MUI) CSS -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@mui/material@5.0.0-beta.4/dist/material-ui.min.css" />

  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />




  <style>
    .icon-container {
      position: fixed;
      /* Fix the position relative to the viewport */
      bottom: 20px;
      /* Distance from the bottom of the screen */
      left: 20px;
      /* Distance from the left of the screen */
      font-size: 40px;
      /* Icon size */
      z-index: 9999;
      /* Make sure it's above other content */
      cursor: pointer;
    }

    .material-icons {
      font-size: 54px;
      /* Customize size */
      color: white;
      /* Customize color */
    }

    html {
      height: 100%;
    }

    body {
      height: 100%;
      overflow: hidden;
      margin: 0;
      padding: 0;
      font-family: Arial, Helvetica, sans-serif;
      font-size: 16px;
      color: #ffffff;
      background-color: #000000;
    }
  </style>
  </head>

  <body>

    <div id="searchBarContainer">
      <div class="search-bar">
        <span class="material-icons search-icon">
          search
        </span>
        <div style="position: relative; flex: 1; display: flex; align-items: center;">
          <input type="text" id="searchBox" placeholder="   Search Plot" oninput="toggleClearIcon(this)"
            onchange="handleSearch(this.value)" class="input-wrapper" />

          <span id="clearIcon" class="material-icons" onclick="clearSearch()">
            close
          </span>
        </div>

      </div>
    </div>






    <!-- Modal -->
    <div id="notFoundModal" class="modal-overlay">
      <div class="modal-box">
        <h2>Plot Not Found In This Zone</h2>
        <p>We couldn’t find any matching results.</p>
        <button onclick="closeModal()">Close</button>
      </div>
    </div>


    <button id="toggle-button" onclick="toggleHotspotColor()">
      <span id="toggle-icon" class="material-icons">toggle_off</span>
    </button>

    <button id="zoomOutBtn">-</button>
    <button id="zoomInBtn">+</button>
    <button id="fullScreenBtn" title="Toggle Fullscreen">⛶</button>

    <div class="time-toggle" onclick="toggleTimeView(this)">
      <div class="toggle-option now active">
        <span class="material-icons">access_time</span> Now
      </div>
      <div class="toggle-option future">
        <span class="material-icons">event</span> Future
      </div>
    </div>

    <div id="custom-breadcrumbs" class="mui-breadcrumb-root">
      <div class="breadcrumb-wrapper" id="breadcrumb-wrapper">
        <!-- Dynamic breadcrumbs addition -->
      </div>
    </div>

    <script src="tour.js"></script>
    <script src="data.js"></script>
    <script src="zone1.js"></script>
    <script src="zone2.js"></script>
    <script src="zone3.js"></script>

    <script src="zone4.js"></script>

    <script src="zone5.js"></script>
    <div class="icon-container" id="homeIcon">
      <span id="arrow-icon" class="material-icons">arrow_circle_left</span>
    </div>

    <div id="pano" style="width: 100%; height: 100%">
      <noscript>
        <table style="width: 100%; height: 100%">
          <tr style="vertical-align: middle">
            <td>
              <div style="text-align: center">
                ERROR:<br /><br />Javascript not activated<br /><br />
              </div>
            </td>
          </tr>
        </table>
      </noscript>
      <script>
        let block_number = "";
        embedpano({
          xml: "tour.xml",
          target: "pano",
          html5: "only",
          mobilescale: 1.0,
          passQueryParameters: "startscene,startlookat",
        });

        let breadcrumbTrail = [
          { scene: "scene_AL_MARINA_aerial", title: "Al Marina", icon: "home" },
        ];

       
        // Mapping scene to readable name (if needed)
        const sceneTitleMap = {
          scene_AL_MARINA_aerial: { title: "Al Marina", icon: "home" },
          scene_zone_2: { title: "Zone 2", icon: "whatshot" },
          scene_zone_4: { title: "Zone 4", icon: "grain" },
          scene_zone_5: { title: "Zone 8", icon: "place" },
          // Add more mappings here
        };

        function updateSearchVisibility(currentScene) {
          console.log('updateSearchVisibility', currentScene);
          const searchBar = document.getElementById('searchBarContainer');
          if (currentScene === 'scene_al_marina_aerial') {
           // searchBar.style.display = 'none';
          } else {
            searchBar.style.display = 'flex';
          }
        }

        // function checkRecord() {
        //   console.log("checkRecord");
        //   const input = document.getElementById("searchBox").value.toLowerCase();

        //   if (input === "notfound" || input === "") {
        //     document.getElementById("notFoundModal").style.display = "block";
        //   }
        // }

        function closeModal() {
          document.getElementById("notFoundModal").style.display = "none";
        }

        function toggleClearIcon(input) {
          const clearIcon = document.getElementById('clearIcon');
          clearIcon.style.display = input.value ? 'block' : 'none';
        }

        function clearSearch() {
          const searchBox = document.getElementById('searchBox');
          searchBox.value = '';
          document.getElementById('clearIcon').style.display = 'none';
          // handleSearch(''); // optional: re-trigger search with empty value
        }

        let currentBlinkInterval = null;
        let currentBlinkingHotspot = null;

        function handleSearch(value) {
          const unitData = localStorage.getItem("response");
          const parsedData = JSON.parse(unitData);

          console.log('parsedData', parsedData);

          
       

          const krpano = document.getElementById("krpanoSWFObject");

          let currentScene = krpano.get("xml.scene"); // Gets the currently loaded scene name

          let zone;


          if (currentScene === 'scene_al_marina_aerial') {
          const unitData = localStorage.getItem("response");
          const parsedData = JSON.parse(unitData);

                const Unit = parsedData.data.find(
                  (house) => house.plot_number === value
                );
               console.log('Zone found:', Unit);
  if (Unit.zone === "ZONE 1") {
    console.log('Zone found:',);
    
    // Load the corresponding scene
    krpano.call(`loadscene(${'scene_al_marina_zone_1__'}, null, MERGE, BLEND(1))`);
  } else if (Unit.zone === "ZONE 2")  {
    console.log("Plot number not found in any zone.");
     krpano.call(`loadscene(${'scene_al_marina_zone_2'}, null, MERGE, BLEND(1))`);
   // document.getElementById("notFoundModal").style.display = "block";
  }else if (Unit.zone === "ZONE 3")  {
    console.log("Plot number not found in any zone.");
     krpano.call(`loadscene(${'scene_al_marina_zone_3'}, null, MERGE, BLEND(1))`);
   // document.getElementById("notFoundModal").style.display = "block";
  }else if (Unit.zone === "ZONE 7")  {
    console.log("Plot number not found in any zone.");
     krpano.call(`loadscene(${'scene_al_marina_zone_4'}, null, MERGE, BLEND(1))`);
   // document.getElementById("notFoundModal").style.display = "block";
  }

 
} else {
  // Handle other scenes here...
}

         
          // Only proceed if we're in Zone 3
          console.log("Current Scene:", currentScene);

         
       
          let matchedHouse;

          currentScene = krpano.get("xml.scene")

          switch (currentScene) {
           
            case "scene_al_marina_zone_1__":
            console.log('scene_al_marina_zone_1__');
              matchedHouse = zone1houseData.find(
                (house) => house.plot_number === value
              );

              const sceneName = matchedHouse;
              console.log('sceneName', sceneName)
              break;
            case "scene_al_marina_zone_2":
            console.log('scene_al_marina_zone_2');
              matchedHouse = zone2houseData.find(
                (house) => house.plot_number === value
              );
              break;
            case "scene_al_marina_zone_3":
            console.log('scene_al_marina_zone_3');
              matchedHouse = zone3houseData.find(
                (house) => house.plot_number === value
              );
              break;

            case "scene_al_marina_zone_4":
            console.log('scene_al_marina_zone_4');
              matchedHouse = zone4houseData.find(
                (house) => house.plot_number === value
              );
              break;

            case "scene_al_marina_zone_5":
            console.log('scene_al_marina_zone_5');
              matchedHouse = zone5houseData.find(
                (house) => house.plot_number === value
              );
              break;

            // You can add more zones here if needed
            default:
              matchedHouse = null;
              break;
          }





          if (matchedHouse) {
            console.log("matchedHouse", matchedHouse);
            const hotspotName = `${matchedHouse.id}`;
            console.log("Hotspot found:", hotspotName);
            blinkHotspot(hotspotName);

            let center = matchedHouse.coordinates?.[0]; // Default to first
            if (matchedHouse.coordinates && matchedHouse.coordinates.length > 1) {
              const total = matchedHouse.coordinates.reduce((acc, point) => {
                acc.ath += parseFloat(point.ath);
                acc.atv += parseFloat(point.atv);
                return acc;
              }, { ath: 0, atv: 0 });
              center = {
                ath: total.ath / matchedHouse.coordinates.length,
                atv: total.atv / matchedHouse.coordinates.length,
              };
            }

            const filteredData = parsedData?.data?.filter(
              (unit) => unit.plot_number === value
            );


            if (unitData && unitData.length > 0) {
              createCard(
                "Title",
                "Description",
                "https://via.placeholder.com/150",
                filteredData
              );
            }

            console.log("center", center);
            krpano.call(`lookat(${center.ath}, ${center.atv}, 20)`); // 70 = moderate zoom
          } else {
            console.log("Hotspot not found for plot number:", value);
            document.getElementById("notFoundModal").style.display = "block";
            closeCard(); // Close any existing card

            // Stop blinking and reset color if a previous hotspot was blinking
            if (currentBlinkInterval && currentBlinkingHotspot) {
              clearInterval(currentBlinkInterval);
              krpano.call(`set(hotspot[${hotspotName}].fillcolor,  "0x00FF00")`);
              currentBlinkInterval = null;
              currentBlinkingHotspot = null;
            }
          }


          // You can replace alert with your own search logic
        }


        function blinkHotspot(hotspotName) {
          console.log("hotspotName", hotspotName)
          const krpano = document.getElementById("krpanoSWFObject");

          let currentScene = krpano.get("xml.scene"); // Gets the currently loaded scene name




if (currentScene !== 'scene_al_marina_aerial') { 
          // Stop previous blinking if any
          if (currentBlinkInterval && currentBlinkingHotspot) {
            clearInterval(currentBlinkInterval);
            // Optionally reset color of previous hotspot
            krpano.call(`set(hotspot[${currentBlinkingHotspot}].fillcolor, 0xFFFFFF)`);
          }

          const blinkColors = ['0x00FFFF', '0xFFA500']  // Cyan & Orange: ['0x00FFFF', '0xFFA500']
          let blinkIndex = 0;

          currentBlinkInterval = setInterval(() => {
            const color = blinkColors[blinkIndex];
            krpano.call(`set(hotspot[${hotspotName}].fillcolor, ${color})`);
            blinkIndex = (blinkIndex + 1) % blinkColors.length;
          }, 500);

          currentBlinkingHotspot = hotspotName;
        }

}
  



        function toggleFullScreen() {
          const elem = document.documentElement;
          const btn = document.getElementById("fullScreenBtn");

          if (
            !document.fullscreenElement &&
            !document.webkitFullscreenElement &&
            !document.msFullscreenElement
          ) {
            // Enter fullscreen
            if (elem.requestFullscreen) {
              elem.requestFullscreen();
            } else if (elem.webkitRequestFullscreen) {
              elem.webkitRequestFullscreen(); // Safari
            } else if (elem.msRequestFullscreen) {
              elem.msRequestFullscreen(); // IE11
            }

            btn.innerHTML = "🗗";
          } else {
            // Exit fullscreen
            if (document.exitFullscreen) {
              document.exitFullscreen();
            } else if (document.webkitExitFullscreen) {
              document.webkitExitFullscreen(); // Safari
            } else if (document.msExitFullscreen) {
              document.msExitFullscreen(); // IE11
            }
            btn.innerHTML = "⛶";
          }
        }

        const toggleTimeView = (element) => {
          const now = element.querySelector(".now");
          const future = element.querySelector(".future");

          const isNowActive = now.classList.contains("active");

          if (isNowActive) {
            now.classList.remove("active");
            future.classList.add("active");
            console.log("Future view");
            // Add your future-view logic here
          } else {
            future.classList.remove("active");
            now.classList.add("active");
            console.log("Now view");
            // Add your now-view logic here
          }
        };

        // Render the breadcrumbs dynamically
        const renderBreadcrumbs = () => {
          console.log("renderBreadcrumbs");
          const wrapper = document.getElementById("breadcrumb-wrapper");
          wrapper.innerHTML = ""; // Clear previous breadcrumbs

          breadcrumbTrail.forEach((crumb, index) => {
            if (index !== 0) {
              // Add separator
              const separator = document.createElement("span");
              separator.className =
                "breadcrumb-separator mui-breadcrumb-separator";
              separator.innerHTML = "&gt;";
              wrapper.appendChild(separator);
            }

            if (index !== breadcrumbTrail.length - 1) {
              // Not the last one - make it a link
              const link = document.createElement("a");
              link.href = "#";
              link.className = "breadcrumb-link mui-breadcrumb-link";
              link.setAttribute("data-scene", crumb.scene);
              link.setAttribute("data-index", index); // Save index for back navigation
              link.innerHTML = `<i class="material-icons mui-breadcrumb-icon">${crumb.icon}</i> ${crumb.title}`;
              wrapper.appendChild(link);
            } else {
              // Last one - current breadcrumb
              const current = document.createElement("span");
              current.className = "breadcrumb-current mui-breadcrumb-current";
              current.innerHTML = `<i class="material-icons mui-breadcrumb-icon">${crumb.icon}</i> ${crumb.title}`;
              wrapper.appendChild(current);
            }
          });

          attachBreadcrumbClickEvents(); // Re-attach click events
        };

        // Attach click listeners to breadcrumb links
        const attachBreadcrumbClickEvents = () => {
          const breadcrumbLinks = document.querySelectorAll(".breadcrumb-link");

          breadcrumbLinks.forEach((link) => {
            link.addEventListener("click", function (e) {
              e.preventDefault();
              const sceneName = this.getAttribute("data-scene");
              const crumbIndex = parseInt(this.getAttribute("data-index"));
              removeBreadCrumbItem(sceneName, crumbIndex);
            });
          });
        };

        const removeBreadCrumbItem = (sceneName, crumbIndex) => {
          var krpano = document.getElementById("krpanoSWFObject");

          if (sceneName) {
            loadScene(sceneName);
            breadcrumbTrail = breadcrumbTrail.slice(0, crumbIndex + 1);
            renderBreadcrumbs();
            krpano.call(`loadscene(${sceneName}, null, MERGE, BLEND(1))`);
          }
        };
        // Load a new scene and update breadcrumb trail
        const loadScene = (sceneName) => {
          // Example krpano call if available
          if (window.krpano) {
            krpano.call(`loadscene(${sceneName}, null, MERGE, BLEND(1))`);
          }

          // Find scene info
          const sceneInfo = sceneTitleMap[sceneName];
          if (sceneInfo) {
            breadcrumbTrail.push({
              scene: sceneName,
              title: sceneInfo.title,
              icon: sceneInfo.icon,
            });
            // renderBreadcrumbs();
          } else {
            console.warn("Scene title not found for:", sceneName);
          }
        };

        // Initial render
        document.addEventListener("DOMContentLoaded", function () {
          renderBreadcrumbs();
        });

        const addCustomDivToHotspot = (hotspotName) => {
          var krpano = document.getElementById("krpanoSWFObject"); // Get krpano instance
          if (krpano) {
          } else {
            console.error("Krpano instance not found");
          }
        };

        // Function to  call the API and fetch data on inital load
        const onInitalLoad = async () => {
          const krpano = document.getElementById("krpanoSWFObject");
          if (!krpano) {
            console.error("Krpano not loaded yet.");
            return;
          }

          const apiData = await fetchAlMarinaData();
          if (!apiData) {
            return;
          }
          return apiData;
        };

        const parseHotspots = (xmlString) => {
          const parser = new DOMParser();
          const xmlDoc = parser.parseFromString(
            `<root>${xmlString}</root>`,
            "text/xml"
          ); // wrap in <root> to make it valid XML

          const hotspotElements = xmlDoc.getElementsByTagName("hotspot");
          const houseData = [];

          Array.from(hotspotElements).forEach((hotspot) => {
            const id = hotspot.getAttribute("name");
            const plot_number = hotspot.getAttribute("plot_number");
            const block_number = hotspot.getAttribute("block_number");

            const points = Array.from(
              hotspot.getElementsByTagName("point")
            ).map((point) => ({
              ath: parseFloat(point.getAttribute("ath")),
              atv: parseFloat(point.getAttribute("atv")),
            }));

            houseData.push({
              id,
              plot_number,
              block_number,
              coordinates: points,
            });
          });

          return houseData;
        };

        const zone1houseData = parseHotspots(zone1hotspotXML);
        const zone3houseData = parseHotspots(zone3hotspotXML);
        const zone2houseData = parseHotspots(zone2hotspotXML);
        const zone4houseData = parseHotspots(zone4hotspotXML);
        const zone5houseData = parseHotspots(zone5hotspotXML);

        let toggleState = false; // Global state for toggling colors (false = color1, true = color2)
        let toggleColorOn = false;



        function toggleHotspotColor(color1 = "0xFF0000", color2 = "0x00FF00") {
          toggleColorOn = !toggleColorOn;

          const krpano = document.getElementById("krpanoSWFObject");
          if (!krpano) {
            console.error("Krpano instance not found");
            return;
          }
          const icon = document.getElementById("toggle-icon");
          icon.textContent = toggleColorOn ? "toggle_on" : "toggle_off";
          console.log("hotspotColorOn", toggleColorOn);
          icon.style.color = toggleColorOn ? "#808e92  " : "#dee2e6";

          // Loop through each house data in zone3houseData
          zone3houseData.forEach((house) => {
            const hotspotName = `hs_${house.id}`; // Assuming house.id is unique
            console.log("hotspotName", hotspotName);

            // Get the current color based on the global toggle state
            const selectedColor = toggleState ? color1 : color2;




            krpano.call(
              `set(hotspot[${hotspotName}].fillcolor, ${selectedColor})`
            );
            console.log(
              `Hotspot ${hotspotName} color changed to ${selectedColor}`
            );
          });

          // Toggle the state for next change
          toggleState = !toggleState;
        }


        function getRandomColor() {
          const letters = "0123456789ABCDEF";
          let color = "#";
          for (let i = 0; i < 6; i++) {
            color += letters[Math.floor(Math.random() * 16)];
          }
          return "0xFF0000";
        }
        const dynamicZoneRendering = (zoneData, response, krpano) => {
          zoneData.forEach((house) => {
            // Create a unique name for each house hotspot
            const hotspotName = `hs_${house.id}`;

            const hotspotColor = getRandomColor();
            const hotspotColorHex = hotspotColor.replace("#", "0x");
            // Generate hotspot with points dynamically
            let hotspotXML = `<hotspot name="${hotspotName}" style="mypolygonalhotspotstylename">`;

            house.coordinates.forEach((point) => {
              hotspotXML += `<point ath="${point.ath}" atv="${point.atv}" />`;
            });
            hotspotXML += `</hotspot>`;

            const cords = house.coordinates[0];



            krpano.call(
              `set(hotspot[${hotspotName}].fillcolor, ${hotspotColorHex})`
            );

            // Set the onclick action to show a Bootstrap tooltip
            krpano.call(`
                        set(hotspot[${hotspotName}].onhover, js(showTooltip('${hotspotName}', '${house.plot_number}','${cords.ath},${cords.atv}')));
                        set(hotspot[${hotspotName}].onout, js(hideTooltip()));
                      `);

            krpano.call(
              `set(hotspot[${hotspotName}].onclick, js(showHouseDetails('${response}', '${house.plot_number}')));`
            );

            // Add hotspot to Krpano dynamically
            krpano.call(`addhotspot(${hotspotName})`);
            krpano.call(
              `set(hotspot[${hotspotName}].loadstyle, mypolygonalhotspotstylename)`
            );

            house.coordinates.forEach((point, index) => {
              krpano.call(
                `set(hotspot[${hotspotName}].point[${index}].ath, ${point.ath})`
              );
              krpano.call(
                `set(hotspot[${hotspotName}].point[${index}].atv, ${point.atv})`
              );
            });
          });
        };

        const addLandHotspotsToKrpano = async () => {
          const krpano = document.getElementById("krpanoSWFObject");
          const response = await onInitalLoad();

          localStorage.setItem("response", JSON.stringify(response));

          if (krpano) {
            const currentScene = krpano.get("xml.scene"); // Gets the currently loaded scene name

            let card = document.getElementById("krpano-card");
            if (card) {
             // card.remove();
            }
            // Only proceed if we're in Zone 3
            console.log("Current Scene:", currentScene);
            updateSearchVisibility(currentScene);
            if (currentScene === "scene_al_marina_zone_1__") {
              breadcrumbTrail.push({
                scene: "scene_zone_1",
                title: "Zone 1",
                icon: "grain",
              });
              renderBreadcrumbs();
              dynamicZoneRendering(zone1houseData, response, krpano);
            }
            else if (currentScene === "scene_al_marina_zone_3") {
              breadcrumbTrail.push({
                scene: "scene_zone_3",
                title: "Zone 3",
                icon: "grain",
              });
              renderBreadcrumbs();
              dynamicZoneRendering(zone3houseData, response, krpano);

            } else if (currentScene === "scene_al_marina_zone_2") {

              console.log("Current Scene:", currentScene);
              dynamicZoneRendering(zone2houseData, response, krpano);
              breadcrumbTrail.push({
                scene: "scene_zone_2",
                title: "Zone 2",
                icon: "grain",
              });
              renderBreadcrumbs();
            } else if (currentScene === "scene_al_marina_zone_4") {
              console.log("Current Scene:", currentScene);
              dynamicZoneRendering(zone4houseData, response, krpano);
              breadcrumbTrail.push({
                scene: "scene_zone_4",
                title: "Zone 7",
                icon: "grain",
              });
              renderBreadcrumbs();
            } else if (currentScene === "scene_al_marina_zone__5") {
              console.log("Current Scene:", currentScene);
              dynamicZoneRendering(zone5houseData, response, krpano);
              breadcrumbTrail.push({
                scene: "scene_zone_5",
                title: "Zone 8",
                icon: "grain",
              });
              renderBreadcrumbs();
            }
          }
        };

        const fetchAlMarinaData = async () => {
          const baseUrl = "https://erth-al-marina.zameengeomatics.com/api/getAlMarinaData";
          return fetch(baseUrl)
            .then((res) => res.json())
            .then((data) => {
              return data;
            })
            .catch((err) => console.error("Error fetching data:", err));
        };

        // Function to show Bootstrap tooltip

        let cardContainer = document.createElement("div");

// Media query for mobile portrait
const portraitQuery = window.matchMedia('(max-width: 768px) and (orientation: portrait)');

// Media query for mobile and tablet landscape
const landscapeQuery = window.matchMedia('(max-width: 1024px) and (orientation: landscape)');

function applyStyles() {
  if (portraitQuery.matches) {
    // Mobile portrait
    cardContainer.style.top = "195px";
    cardContainer.style.height = "200px";
    cardContainer.style.overflowY = "auto";
    cardContainer.style.bottom = ""; // Clear bottom if needed
  } else if (landscapeQuery.matches) {
    // Mobile or tablet in landscape
    cardContainer.style.bottom = "100px";
    cardContainer.style.height = "200px";
    cardContainer.style.overflowY = "auto";
    cardContainer.style.top = "";
  } else {
    // Other devices / orientations
    cardContainer.style.top = "195px";
    cardContainer.style.height = "";
    cardContainer.style.overflowY = "";
    cardContainer.style.bottom = "";
  }
}

// Initial check
  applyStyles();

// Listen for changes
  portraitQuery.addListener(applyStyles);
  landscapeQuery.addListener(applyStyles);

        function createCard(title, description, imageUrl, response) {
          let unitDetails = {
            zone: response[0].zone,
            plot_number: response[0].plot_number,
            block_number: response[0].block_number,
            total_area: response[0].total_area,
            usage: response[0].usage,
            south: response[0]["الجنوب "],
            west: response[0].west,
            north: response[0].north,
            east: response[0].east,
          };

          
          let existingCard = document.getElementById("krpano-card");
          if (existingCard) {
           // existingCard.remove();
          }

          
         
          cardContainer.id = "krpano-card";
          cardContainer.style.position = "absolute";
       
          cardContainer.style.left = "20px";
          cardContainer.style.width = "210px";
          cardContainer.style.zIndex = "1000";
          cardContainer.style.background =
            "linear-gradient(135deg, rgb(58, 58, 58), rgb(0 0 0 / 68%))";

          cardContainer.style.borderRadius = "13px";
          cardContainer.style.boxShadow = "0 12px 24px rgba(0, 0, 0, 0.15)";
          cardContainer.style.padding = "9px";
          cardContainer.style.fontFamily = "'Segoe UI', sans-serif";
          cardContainer.style.color = "#ffffff"; // White text
     
          cardContainer.innerHTML = `
  <div  class="card-header" style="display: flex; align-items: center; border-bottom: 2px solid #ccc; padding-bottom: 10px; margin-bottom: 10px;">
    <button onclick="closeCard()" style="
    position: absolute; top: 10px; right: 10px;
      background: transparent;
      border: none;
      color: #fff;
      font-size: 20px;
      cursor: pointer;
      padding: 0;
      margin-right: 10px;
      // line-height: 1;
       display: inline-block 
    ">&times;</button>
    <h5 class="card-title" style="margin: 0; color: #ffffff;">🏙️ Al Marina City</h5>
  </div>

  <p style="margin: 6px 0;">🏡 Plot Number:</strong> ${unitDetails.plot_number}</p>
  <p style="margin: 6px 0;">🏢 Block Number:</strong> ${unitDetails.block_number}</p>
  <p style="margin: 6px 0;">📊 Total Area:</strong> ${unitDetails.total_area} sq.m</p>

  

  <div class="extra-details">
    <p style="margin: 6px 0;">🗂️ Usage:</strong> ${unitDetails.usage}</p>
    <p style="margin: 6px 0;">⬇️ South:</strong> ${unitDetails.south}</p>
    <p style="margin: 6px 0;">⬆️ North:</strong> ${unitDetails.north}</p>
    <p style="margin: 6px 0;">⬆️ East:</strong> ${unitDetails.east}</p>
    <p style="margin: 6px 0;">⬅️ West:</strong> ${unitDetails.west}</p>
  </div>
 <div class="hideDetails" onclick="toggleDetails()" style="
    display: flex;
    align-items: center;
    cursor: pointer;
    color: #dee2e6;
    margin: 10px 0;
    font-weight: bold;
">
    <span  id="toggleArrow" style="margin-left: 5px; font-size: 14px; position: absolute; right: 100px; ">▼</span>
</div>
`;

          document.body.appendChild(cardContainer);
        }

        const closeCard = () => {
          console.log()
          let card = document.getElementById("krpano-card");
          if (card) {
            card.remove();
          }
        };

        const toggleDetails = () => {
          const arrow = document.getElementById('toggleArrow');

          const details = document.querySelector('.extra-details');
          const btn = document.querySelector('.show-details-button');

          const isHidden = details.style.display === 'none' || details.style.display === '';
          arrow.textContent = isHidden ? '▲' : '▼';

          if (details.style.display === 'block') {
            details.style.display = 'none';

          } else {
            details.style.display = 'block';

          }
        }

        // Function to display house details
        const showHouseDetails = (response, plot_number) => {

          let card = document.getElementById("krpano-card");
            if (card) {
            card.remove();
            }
          const unitData = localStorage.getItem("response");

          const parsedData = JSON.parse(unitData);

          const filteredData = parsedData?.data?.filter(
            (unit) => unit.plot_number === plot_number
          );

          //   Assuming the first element in the response array corresponds to the clicked house
          if (unitData && unitData.length > 0) {
            createCard(
              "Title",
              "Description",
              "https://via.placeholder.com/150",
              filteredData
            );
          } else {
            console.error("House details not found in the response.");
          }
        };

        const showTooltip = (hotspotName, houseId, cords) => {
          // Convert string back to an array

          const coordinatesString = cords;
          const coordinatesArray = coordinatesString.split(",").map(Number);
          const krpano = document.getElementById("krpanoSWFObject");

          let existingTooltip = document.getElementById("hotspot-tooltip");
          if (existingTooltip) {
            existingTooltip.remove(); // Remove existing tooltip if it exists
          }

          // if (krpano && krpano.get) {
          //   console.log("IF WORKING");
          // }

          if (!krpano || !krpano.get) {
            console.error("Krpano is not ready yet.");
            return;
          }
          // Convert hotspot position to screen coordinates

          const tooltip = document.createElement("div");
          tooltip.id = "hotspot-tooltip";
          tooltip.className = "tooltip bs-tooltip-top show"; // Bootstrap tooltip classes
          tooltip.setAttribute("role", "tooltip");

          // Tooltip inner content
          tooltip.innerHTML = `
                    <div class="tooltip-arrow"></div>
                      <div class="tooltip-inner">
                      🏠 Plot: ${houseId} <br> Click for details
                      </div>
                  `;

          // Apply Bootstrap styles
          tooltip.style.position = "absolute";

          tooltip.style.top = "500px"; // Adjust as necessary
          tooltip.style.left = "50%";

          // tooltip.style.top = `${y}px`;
          // tooltip.style.left = `${x}px`;
          tooltip.style.transform = "translateX(-50%)";
          tooltip.style.zIndex = "1000";

          document.body.appendChild(tooltip);

          // Remove the tooltip after 3 seconds
          setTimeout(() => {
            tooltip.remove();
          }, 3000);
        };
        // Function to hide the tooltip when the mouse leaves
        const hideTooltip = () => {
          let existingTooltip = document.getElementById("hotspot-tooltip");
          if (existingTooltip) {
            existingTooltip.remove();
          }
        };

        // Zoom in function
        const zoomIn = () => {
          const krpano = document.getElementById("krpanoSWFObject");

          krpano.call("set(fov_moveforce,-1);");
        };

        const zoomOut = () => {
          const krpano = document.getElementById("krpanoSWFObject");

          krpano.call("set(fov_moveforce,+1);");
          // Wait briefly to ensure the scene is ready, then zoom
        };
        const enableZoomControls = () => {
          document
            .getElementById("zoomInBtn")
            .addEventListener("click", function () {
              zoomIn();
            });

          document
            .getElementById("zoomOutBtn")
            .addEventListener("click", function () {
              zoomOut();
            });

          document
            .getElementById("fullScreenBtn")
            .addEventListener("click", function () {
              toggleFullScreen();
            });
        };

        window.onload = () => {
          setTimeout(() => {
            if (typeof krpano !== "undefined" && krpano !== null) {
              console.log("setTimeout Krpano Initialized");
              onInitalLoad();
            }
          }, 1000);

          document
            .getElementById("homeIcon")
            .addEventListener("click", function () {
              var krpano_obj = document.getElementById("krpanoSWFObject");

              if (krpano_obj && krpano_obj.call) {
                // Load new scene
                breadcrumbTrail = [
                  {
                    scene: "scene_AL_MARINA_aerial",
                    title: "Al Marina",
                    icon: "home",
                  },
                ];
                renderBreadcrumbs();

                krpano_obj.call(
                  "loadscene(scene_AL_MARINA_aerial, null, MERGE);"
                );

                // Wait a bit to ensure scene is loaded, then change color
                setTimeout(function () {
                  krpano_obj.call(
                    "set(hotspot[hotspot1].fillcolor, 0xFF0000);"
                  );
                  krpano_obj.call("set(hotspot[hotspot1].fillalpha, 0.8);");
                }, 2000);
              } else {
                console.error("Krpano instance not found!");
              }
            });
          const krpano = document.getElementById("krpanoSWFObject");

          addCustomDivToHotspot("hs1"); // Replace 'hs1' with your hotspot ID

          setTimeout(() => {
            if (typeof krpano !== "undefined" && krpano !== null) {
              console.log("setTimeout Krpano Initialized");

              //addLandHotspotsToKrpano();
            }
            krpano.call("set(tooltip_pos.x, 0)");
            krpano.call("set(tooltip_pos.y, 0)");

            krpano.call(
              "lookto(0.26823401616246656, -0.08515741582446189, 90, 0)"
            );

            // Always update screen bounds first
            krpano.call("updatescreenbounds()");

            // Convert sphereto screen
            krpano.call(
              `spheretoscreen(0.26823401616246656, -0.08515741582446189, tooltip_pos)`
            );

            // Get screen X, Y
            const screenX = krpano.get("tooltip_pos.x");
            const screenY = krpano.get("tooltip_pos.y");

            console.log("Screen position:", screenX, screenY);
          }, 1000);

          // Delay to ensure Krpano loads
          updateSearchVisibility(krpano.get("xml.scene"));

          if (typeof krpano !== "undefined" && krpano !== null) {
            console.log("Krpano onloadcomplete");

            // or however your app provides scene name

            krpano.set(
              "events.onloadcomplete",
              "js(enableZoomControls()); js(addLandHotspotsToKrpano());"
            );
          }
        };
      </script>
    </div>
  </body>

</html>