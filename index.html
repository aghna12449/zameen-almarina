<!DOCTYPE html>
<html>
  <head>
    <title>Al Marina</title>

    <meta charset="UTF-8" />
    <meta name="viewport" , initial-scale="1.0" , maximum-scale="1.0," />
    <meta http-equiv="ScreenOrientation" content="autoRotate:disabled" />

    <meta name="viewport" content=" user-scalable=no" />
    <!-- <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, viewport-fit=cover"
    /> -->
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
    <meta http-equiv="x-ua-compatible" content="IE=edge" />

    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"
    />

    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
    />
    <!-- adding style sheet -->
    <link rel="stylesheet" href="main.css" />

    <link rel="stylesheet" href="initalCard.css" />
    <link rel="stylesheet" href="slider.css" />
    <link rel="stylesheet" href="searchFilter.css" />
    <link rel="stylesheet" href="mobileSearchFilter.css" />
    <link rel="stylesheet" href="houseCard.css" />

    <link rel="stylesheet" href="drone.css" />

    <!-- Add Material-UI (MUI) CSS -->
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/icon?family=Material+Icons"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/@mui/material@5.0.0-beta.4/dist/material-ui.min.css"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css"
      rel="stylesheet"
    />

    <link
      href="https://fonts.googleapis.com/icon?family=Material+Icons"
      rel="stylesheet"
    />

    <style>
      .icon-container {
        position: fixed;
        /* Fix the position relative to the viewport */
        bottom: 20px;
        /* Distance from the bottom of the screen */
        left: 20px;
        /* Distance from the left of the screen */
        font-size: 40px;
        /* Icon size */
        z-index: 9999;
        /* Make sure it's above other content */
        cursor: pointer;
      }

      .material-icons {
        font-size: 54px;
        /* Customize size */
        color: white;
        /* Customize color */
      }

      html {
        height: 100%;
        touch-action: none;
      }

      body {
        height: 100%;
        overflow: hidden;
        margin: 0;
        padding: 0;
        font-family: Arial, sans-serif;
        font-size: 16px;
        /* color: #ffffff; */
        background-color: transparent !important;
        touch-action: none;
      }
    </style>
  </head>

  <body>
    <script src="tour.js"></script>

    <script src="zone1.js"></script>
    <script src="zone2.js"></script>
    <script src="zone3.js"></script>
    <script src="zone4_mall.js"></script>
    <script src="zone5_building2.js"></script>
    <script src="zone6_building1.js"></script>
    <script src="zone7.js"></script>
    <script src="zone8.js"></script>

    <script src="zone9.js"></script>

    <div id="viewport">
      <!-- Your krpano viewer or other content -->
    </div>

    <div id="pano" style="width: 100%; height: 100%">
      <noscript>
        <table style="width: 100%; height: 100%">
          <tr style="vertical-align: middle">
            <td>
              <div style="text-align: center">
                ERROR:<br /><br />Javascript not activated<br /><br />
              </div>
            </td>
          </tr>
        </table>
      </noscript>

      <!-- <div class="icon-container" id="homeIcon">
      <span id="arrow-icon" class="material-icons">arrow_circle_left</span>
    </div> -->

      <!-- <div id="searchSliderFilters" class="slider-container_1">
      <div class="card-slider_1"></div>
    </div>  -->

      <!-- <div id="zone_5_360_icon" class="zone_5_360_icon_class">
           <img src="/skin/icons/360_1.png" width="50%" height="50%" class="" />
          
         </div> -->

      <div id="top-button-360" class="top-button-360-container">
        <button class="top-close-button" onclick="goBackToZone()">
          &times;
        </button>
        <!-- Your content here -->
      </div>

      <div id="searchBarContainer" hidden>
        <input
          type="checkbox"
          id="toggleFilter"
          class="hidden-checkbox"
          checked
        />

        <label
          for="toggleFilter"
          class="toggle-container"
          id="toggleFilterButton"
        >
          <div class="toggle-icon-wrapper">
            <span id="toggleArrow_1"></span>
          </div>
        </label>

        <div class="container mt-5">
          <div class="card shadow rounded-1 compact-search-card">
            <div class="card-body">
              <h5 class="card-title mb-4 fw-semibold">Search Filter</h5>
              <div class="mb-3">
                <div class="input-group">
                  <input
                    type="text"
                    class="form-control custom-mobile-input"
                    id="plotNumber"
                    placeholder="Plot Number"
                    onkeyup="onEnterPlotNumber(event)"
                  />
                </div>
              </div>
              <div>
                <div class="dropdown-wrapper mt-1 mb-3">
                  <select
                    class="form-select custom-dropdown"
                    id="availabilityDropdown"
                    name="availability"
                  >
                    <option value="Available">Available</option>
                    <option value="Sold">Sold</option>
                    <option value="Reserved">Reserved</option>
                  </select>
                  <i class="bi bi-caret-down-fill"></i>
                </div>
              </div>
              <div class="mb-3">
                <label for="totalArea_" class="form-label">
                  <label class="form-label fw-semibold">Area Range: </label>
                  <span id="areaValue">100</span> to
                  <span id="areaMax">20000</span> sq m
                </label>
                <input
                  type="range"
                  class="form-range"
                  min="100"
                  max="20000"
                  step="1"
                  id="totalArea"
                  value="50000"
                  oninput="updateAreaAndSearch(this.value)"
                />
              </div>
              <button
                class="btn btn-primary custom-width"
                onclick="handleSearchFilters()"
              >
                Search
              </button>
              <div class="mt-3 d-flex justify-content-center my-3">
                <button
                  class="btn btn-link p-0 ml-5 text-decoration-none"
                  type="button"
                  onclick="resetFilters()"
                >
                  <i class="fas fa-sync-alt me-2"></i> Reset Filters
                </button>
              </div>
              <div id="moreOptions" style="display: none">
                <div class="mt-2">
                  <label class="form-label fw-semibold">Availability</label>
                </div>
                <div class="mt-1 mb-3" id="availabilityButtons">
                  <button
                    class="btn btn-outline-primary me-2"
                    data-value="Available"
                  >
                    Available
                  </button>
                  <button
                    class="btn btn-outline-success me-2"
                    data-value="Sold"
                  >
                    Sold
                  </button>
                  <button class="btn btn-outline-warning" data-value="Reserved">
                    Reserved
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div id="mobileSearchFilter" style="display: none">
        <div class="mobile-container mt-5">
          <div class="card shadow rounded-1 mobile-compact-search-card">
            <div class="mobile-card-body">
              <h5 class="mobile-card-title mb-4" onclick="toggleMobileFilter()">
                Search Filter
              </h5>

              <!-- Collapsible Content -->
              <div
                id="mobileFilterBody"
                class="mobile-card-body"
                style="display: none"
              >
                <div class="mb-3">
                  <div class="mobile-input-group">
                    <input
                      type="text"
                      class="form-control custom-mobile-input"
                      placeholder="Plot Number"
                      onkeyup="onEnterPlotNumber(event)"
                      id="plotNumber"
                    />
                  </div>
                </div>
                <div>
                  <div class="mt-1 mb-3">
                    <select
                      class="form-select mobile-custom-dropdown"
                      id="availabilityDropdownMobile"
                      name="availability"
                    >
                      <option value="Available">Available</option>
                      <option value="Sold">Sold</option>
                      <option value="Reserved">Reserved</option>
                    </select>
                  </div>
                </div>
                <div class="mb-3">
                  <label for="totalArea_">
                    <label class="area-range">Area Range: </label>
                    <span id="mobileAreaValue">100</span> to
                    <span id="mobileAreaMax">20000</span> sqm
                  </label>
                  <input
                    type="range"
                    class="form-range"
                    min="100"
                    max="20000"
                    step="50"
                    id="totalArea"
                    value="100"
                    oninput="updateAreaAndSearch(this.value)"
                  />
                </div>

                <div class="d-flex justify-content-center">
                  <button
                    class="btn btn-primary"
                    onclick="handleSearchFilters()"
                  >
                    Search
                  </button>
                </div>

                <div class="mt-3 d-flex justify-content-center my-3">
                  <button
                    class="btn btn-link p-0 ml-5 text-decoration-none"
                    type="button"
                    onclick="resetFilters()"
                  >
                    <i class="fas fa-sync-alt me-2"></i> Reset Filters
                  </button>
                </div>
                <div id="moreOptions" style="display: none">
                  <div class="mt-2">
                    <label class="form-label-mobile fw-semibold"
                      >Availability</label
                    >
                  </div>
                  <div class="mt-1 mb-3" id="availabilityButtons">
                    <button
                      class="btn btn-outline-primary me-2"
                      data-value="Available"
                    >
                      Available
                    </button>
                    <button
                      class="btn btn-outline-success me-2"
                      data-value="Sold"
                    >
                      Sold
                    </button>
                    <button
                      class="btn btn-outline-warning"
                      data-value="Reserved"
                    >
                      Reserved
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Modal -->
      <div id="notFoundModal" class="modal-overlay">
        <div class="modal-box">
          <h2>Plot Not Found In This Zone</h2>
          <p>We couldn’t find any matching results.</p>
          <button onclick="closeModal()">Close</button>
        </div>
      </div>

      <div id="controls">
        <!-- <button id="fullScreenBtn" title="Toggle Fullscreen">⛶</button> -->
        <!-- <button id="zoomInBtn">+</button>

        <button id="zoomOutBtn">-</button> -->
        <div
          id="toggle_layer_wrapper"
          style="display: flex; align-items: center; gap: 8px"
        >
          <span id="toggle-text" style="margin-bottom: 15px">Layer</span>
          <button id="toggle-button" onclick="toggleHotspotColor()">
            <span id="toggle-icon" class="material-icons" style="color: #a65c43"
              >toggle_on</span
            >
          </button>
        </div>
      </div>
      <div id="time-toggle" class="time-toggle" style="display: none">
        <div class="toggle-option now active" onclick="toggleTimeView(this)">
          <span class="material-icons">access_time</span> Now
        </div>
        <div class="toggle-option future" onclick="toggleTimeView(this)">
          <span class="material-icons">event</span> Future
        </div>
      </div>

      <div id="custom-breadcrumbs" class="mui-breadcrumb-root">
        <div class="breadcrumb-wrapper" id="breadcrumb-wrapper">
          <!-- Dynamic breadcrumbs addition -->
        </div>
      </div>

      <div id="searchSliderFilters" class="slider-container_1">
        <div class="card-slider_1"></div>
      </div>

      <script>
        embedpano({
          xml: "tour.xml",
          target: "pano",
          html5: "only",

          onready: function (krpano) {},
        });
      </script>

      <script>
        const isSafari = /^((?!chrome|android).)*safari/i.test(
          navigator.userAgent
        );
        console.log("Is Safari:", isSafari);

        const input = document.getElementById("plotNumber");

        input.addEventListener("input", function () {
          if (true) {
            if (this.value.trim() !== "") {
              this.style.fontSize = "60px"; // Shrink when user types
            } else {
              this.style.fontSize = "48px"; // Reset when cleared
            }
          }
        });
        console.log("Input changed:", input);

        let zoneMaximum = 20000;

        const globalKrpano = () => {
          const krpano = document.getElementById("krpanoSWFObject");
          if (!krpano) {
            console.error("Krpano instance not found");
            return;
          }
          return krpano;
        };

        const flyToInitialAlMarinaScene = () => {
          const krpano = document.getElementById("krpanoSWFObject");
          const currentFov = krpano.get("view.fov");

          const fov = currentFov; // Or whatever default FOV you need

          const animationSpeed = 0.1;
          const currentScene = krpano.get("xml.scene");

          if (currentScene === "scene_a-initial") {
            console.log("currentScene", currentScene);
            // Smooth zoom to FOV 40 (or whatever value you want)

            //  krpano.call("set(fov_moveforce,-1.8);");
            //  krpano.set("view.fovmin", 0.09);
            //    krpano.set("view.fovmax", 1.9);

            //  krpano.call("tween(view.fov, 70, 1);");
          }

          if (krpano) {
            // krpano.call("delayedcall(0.1, looktohotspot(hs_AlMarinaLogo_big));");
            //  setTimeout(() => {
            //  krpano.call(
            //   "delayedcall(0.9, looktohotspot(hs_AlMarinaLogo_big));"
            // );
            //}, 1000);
          } else {
            console.error("Krpano instance not found or not ready.");
          }
        };

        const slider = document.querySelector(".card-slider_1");

        let isDown = false;
        let startX;
        let scrollLeft;

        slider.addEventListener("mousedown", (e) => {
          isDown = true;
          slider.classList.add("active");
          startX = e.pageX - slider.offsetLeft;
          scrollLeft = slider.scrollLeft;
        });

        slider.addEventListener("mouseleave", () => {
          // Reset the state when mouse leaves the slider
          isDown = false;
          slider.classList.remove("active");
        });

        slider.addEventListener("mouseup", () => {
          // Reset the state when mouse is released

          isDown = false;
          slider.classList.remove("active");
        });

        slider.addEventListener("mousemove", (e) => {
          if (!isDown) return;
          e.preventDefault();
          const x = e.pageX - slider.offsetLeft;
          const walk = (x - startX) * 2; // Adjust scroll speed
          slider.scrollLeft = scrollLeft - walk;
        });

        slider.addEventListener(
          "wheel",
          (e) => {
            // Only convert vertical scroll to horizontal if there's no shift key
            if (Math.abs(e.deltaY) > Math.abs(e.deltaX)) {
              e.preventDefault(); // prevent vertical scroll
              slider.scrollLeft += e.deltaY;
            }
          },
          { passive: false }
        );

        const showSearchFilterCardsMobile = () => {
          const isLandscapeView = window.matchMedia(
            "(orientation: landscape)"
          ).matches;
          const krpano = document.getElementById("krpanoSWFObject");
          const currentScene = krpano.get("xml.scene");

          const viewport = document.getElementById("viewport");
          viewport.style.transform = "scale(0.4)";
          viewport.style.transformOrigin = "top left";

          console.log("viewport", viewport);

          // krpano.call("tween(view.fov, 30, 1.0);");
          //krpano.call("tween(view.fov, 90, 1.0);");
          if (isLandscapeView) {
            console.log("Landscape mode detected");
            if (currentScene === "scene_b-al_marina_aerial") {
              //  krpano.call("looktohotspot('hs_zone_1_360(1)')");
            } else if (currentScene === "scene_a-initial") {
              // document.body.style.zoom = "40%";
            } else {
              // document.body.style.zoom = "100%";
            }
            // Add your landscape-specific code here
          } else {
            console.log("Portrait mode detected");

            // Add your portrait-specific code here
          }

          const searchSliderFilters =
            document.getElementById("searchBarContainer");
          const mobileSearchFilter =
            document.getElementById("mobileSearchFilter");
          const toggleFilterButton =
            document.getElementById("toggleFilterButton");

          const sliderContainer = document.querySelector(".card-slider_1");

          const width = window.innerWidth;
          const height = window.innerHeight;
          const isLandscape = width > height;

          if (
            currentScene !== "scene_a-initial" &&
            currentScene !== "scene_b-al_marina_aerial"
          ) {
            if (width < 935 && height < 440 && isLandscape) {
              if (String(currentScene).includes("_360")) {
                searchSliderFilters.style.display = "none";

                console.log("mobile search filter 360");
                mobileSearchFilter.style.display = "none";
                toggleFilterButton.style.display = "none";
              } else {
                console.log("mobile search filter");
                const propertyCard = document.getElementById("krpano-card");

                if (propertyCard) {
                  propertyCard.style.width = "225px";
                  propertyCard.style.height = "230px";
                  propertyCard.style.right = "30px";
                  // propertyCard.style.top = "%";
                }

                searchSliderFilters.style.display = "none";
                mobileSearchFilter.style.display = "block";
                toggleFilterButton.style.display = "none";

                mobileSearchFilter.style.marginTop = "10px";
                mobileSearchFilter.style.marginBottom = "5px";
                //mobileSearchFilter.style.right = "20px";

                mobileSearchFilter.style.height = "200px";
                mobileSearchFilter.style.overflowY = "auto";

                const labelbox = document.querySelector(".top-label-box");

                const rowExtra =
                  document.querySelectorAll(".details-row_extra");
                if (rowExtra) {
                  rowExtra.forEach((row) => {
                    row.style.display = "flex";
                  });
                }

                const wrappers = document.querySelectorAll(".card-wrapper");

                wrappers.forEach((wrapper) => {
                  const card = wrapper.querySelector(".card_1");
                  const labelbox = wrapper.querySelector(".top-label-box");

                  console.log("CARD", card, "labelbox", labelbox);

                  if (card) {
                    card.style.top = "30px";
                    card.style.height = "7rem";
                    // card.style.maxHeight = "6rem";
                  }

                  if (labelbox) {
                    labelbox.style.top = "50px";
                  }
                });
              }
            } else if (width < 768) {
              if (String(currentScene).includes("_360")) {
                searchSliderFilters.style.display = "none";
                mobileSearchFilter.style.display = "none";
                toggleFilterButton.style.display = "none";
              } else {
                searchSliderFilters.style.display = "none";
                mobileSearchFilter.style.display = "block";
                toggleFilterButton.style.display = "none";
                mobileSearchFilter.style.left = "20px";

                mobileSearchFilter.style.height = "";

                const propertyCard = document.getElementById("krpano-card");
                console.log("propertyCard 768", propertyCard);
                if (propertyCard) {
                  propertyCard.style.width = "225px";
                  propertyCard.style.height = "auto";

                  propertyCard.style.right = "30px";
                  propertyCard.style.top = "7%";
                }

                const rowExtra =
                  document.querySelectorAll(".details-row_extra");
                if (rowExtra) {
                  rowExtra.forEach((row) => {
                    row.style.display = "flex";
                  });
                }

                const wrappers = document.querySelectorAll(".card-wrapper");

                wrappers.forEach((wrapper) => {
                  const card = wrapper.querySelector(".card_1");
                  const labelbox = wrapper.querySelector(".top-label-box");

                  console.log("CARD", card, "labelbox", labelbox);

                  if (card) {
                    card.style.top = "30px";
                    // card.style.height = "7rem";
                    // card.style.maxHeight = "6rem";
                  }

                  if (labelbox) {
                    labelbox.style.top = "50px";
                  }
                });
              }
            } else {
              if (String(currentScene).includes("_360")) {
                searchSliderFilters.style.display = "none";
                mobileSearchFilter.style.display = "none";
                toggleFilterButton.style.display = "none";
              } else {
                searchSliderFilters.style.display = "block";
                toggleFilterButton.style.display = "block";
              }

              mobileSearchFilter.style.display = "none";

              // mobileSearchFilter.style.right = "0";

              mobileSearchFilter.style.height = "";

              const wrappers = document.querySelectorAll(".card-wrapper");

              wrappers.forEach((wrapper) => {
                const card = wrapper.querySelector(".card_1");
                const labelbox = wrapper.querySelector(".top-label-box");

                console.log("CARD", card, "labelbox", labelbox);

                if (card) {
                  card.style.top = "0rem";
                  card.style.height = "10rem";
                }

                if (labelbox) {
                  labelbox.style.top = "15px";
                }
              });

              const propertyCard = document.getElementById("krpano-card");
              console.log("propertyCard", propertyCard);

              if (width > 1025) {
                if (propertyCard) {
                  console.log("inital load first ");
                  propertyCard.style.right = "90px";
                  propertyCard.style.top = "12%";
                }
              } else {
                console.log("inital load second");
                if (propertyCard) {
                  propertyCard.style.right = "20px";
                  propertyCard.style.top = "7%";
                }
              }

              const rowExtra = document.querySelectorAll(".details-row_extra");
              if (rowExtra) {
                rowExtra.forEach((row) => {
                  row.style.display = "flex";
                });
              }
            }
          }
        };

        window.addEventListener("load", showSearchFilterCardsMobile);
        window.addEventListener("resize", showSearchFilterCardsMobile);

        document
          .querySelectorAll("#availabilityButtons button")
          .forEach((button) => {
            button.addEventListener("click", function () {
              const selectedValue = this.getAttribute("data-value");

              // Example: Store in a variable or send to server
              // availabilitySelected = selectedValue;
            });
          });

        function toggleMobileFilter() {
          const body = document.getElementById("mobileFilterBody");
          if (body.style.display === "none" || body.style.display === "") {
            body.style.display = "block";
          } else {
            body.style.display = "none";
          }
        }

        let sliderSearchedHouses;

        const onEnterPlotNumber = (event) => {
          if (event.key === "Enter") {
            handleSearchFilters();
            // You can call any function here or trigger a search, etc.
          }
        };

        const resetFilters = () => {
          const plotInput = document.getElementById("plotNumber");
          if (plotInput) {
            plotInput.value = "";
          }

          // Reset the total area slider
          let krpano = globalKrpano();
          const slider = document.getElementById("totalArea");
          const plot = document.getElementById("plotNumber");
          slider.min = "100";
          slider.value = zoneMaximum; // or whatever your default value is
          plot.value = "";
          document.getElementById("areaValue").textContent = "100";
          document.getElementById("areaMax").textContent = "20000";

          document.getElementById("mobileAreaValue").textContent = "100";
          document.getElementById("mobileAreaMax").textContent = "20000";

          const currentScene = krpano.get("xml.scene");
          if (plot) {
            switchZoneRendering(currentScene, krpano);
          }

          sliderSearchedHouses = [];
          stopAllBlinkingHotspots();
          blinkHotspot();
          displayHorizontalSlider();

          closeCard();
        };

        const switchZoneRendering = (currentScene, krpano) => {
          const slider = document.getElementById("totalArea");
          slider.dispatchEvent(new Event("input"));

          switch (currentScene) {
            case "scene_c-zone_1":
              updateSliderRange("1");
              slider.value = 17215;
              dynamicZoneRendering(zone1houseData, "", krpano);
              break;

            case "scene_d-zone_2":
              updateSliderRange("2");
              slider.value = 2485;
              dynamicZoneRendering(zone2houseData, "", krpano);
              break;

            case "scene_e-zone_3":
              updateSliderRange("3");
              slider.value = 2328;
              dynamicZoneRendering(zone3houseData, "", krpano);
              break;

            case "scene_i-building_2":
              updateSliderRange("5");
              slider.value = 6038;
              dynamicZoneRendering(building2houseData, "", krpano);

              break;

            case "scene_h-building_1":
              updateSliderRange("1");
              slider.value = 15202;
              dynamicZoneRendering(building1houseData, "", krpano);

              break;

            case "scene_f-zone_4":
              updateSliderRange("7");
              slider.value = 2365;
              dynamicZoneRendering(zone7houseData, "", krpano);
              break;

            case "scene_g-zone_5":
              updateSliderRange("8");
              slider.value = 4361;
              dynamicZoneRendering(zone8houseData, "", krpano);
              break;

            case "scene_k_zone_9":
              updateSliderRange("9");
              slider.value = 16038;
              dynamicZoneRendering(zone9houseData, "", krpano);

              break;

            default:
              break;
          }
        };

        const arialView = () => {
          const krpano = document.getElementById("krpanoSWFObject");
          if (krpano) {
            krpano.call(
              "loadscene(scene_b-AL_MARINA_aerial, null, MERGE, BLEND(1));"
            );
          }

          const sceneCardWrapper =
            document.getElementById("scene-card-wrapper");
          if (sceneCardWrapper) {
            sceneCardWrapper.style.display = "none";
          }
        };

        const getCurrentScene = () => {
          const krpano = document.getElementById("krpanoSWFObject");

          const currentScene = krpano.get("xml.scene");
          return currentScene;
        };

        const goBackToZone = () => {
          const krpano = document.getElementById("krpanoSWFObject");
          const lastCrumb = breadcrumbTrail[breadcrumbTrail.length - 1];
          const slider = document.getElementById("totalArea");
          //  slider.dispatchEvent(new Event('input'));

          console.log("goBacktozone", lastCrumb);
          if (krpano) {
            krpano.call(`loadscene(${lastCrumb.scene}, null, MERGE, BLEND(1))`);

            setTimeout(() => {
              updateSliderRange("3"); // Use your actual zone identifier here
              switchZoneRendering(lastCrumb.scene, krpano);

              console.log("Reinitialized slider for zone:", lastCrumb.scene);
            }, 100); // Adjust delay if needed
          }
        };
        const toggleMoreOptions = () => {
          const moreOptions = document.getElementById("moreOptions");
          moreOptions.style.display =
            moreOptions.style.display === "none" ? "block" : "none";
        };

        let previouslyVisibleHotspots = [];

        let newHotspotArray = [];

        const totalLength = (currentScene) => {
          if (currentScene === "scene_c-zone_1") {
            return zone1houseData.length;
          } else if (currentScene === "scene_d-zone_2") {
            return zone2houseData.length;
          } else if (currentScene === "scene_e-zone_3") {
            return zone3houseData.length;
          } else if (currentScene === "scene_l_al_marina_mall_day_aerial") {
            return 0; // No houses in this scene
          } else if (currentScene === "scene_f-zone_4") {
            return zone7houseData.length;
          } else if (currentScene === "scene_g-zone_5") {
            return zone8houseData.length;
          } else if (currentScene === "scene_h-building_1") {
            return building1houseData.length;
          } else if (currentScene === "scene_i-building_2") {
            return building2houseData.length;
          } else if (currentScene === "scene_k_zone_9") {
            return zone9houseData.length;
          } else {
            return 0; // Default to 0 if scene is unknown
          }
        };

        const updateAreaAndSearch = (value) => {
          const plotInput = document.getElementById("plotNumber");
          if (plotInput) {
            plotInput.value = "";
          }

          const krpano = document.getElementById("krpanoSWFObject");
          const currentScene = krpano.get("xml.scene");
          // document.getElementById("areaValue").innerText = `${value}`;
          //  document.getElementById("mobileAreaValue").innerText = `${value}`;

          const totalHotspots = krpano.get("hotspot.count");

          sliderSearchedHouses = getSpeificUnitsByArea();

          if (sliderSearchedHouses) {
            let initial = sliderSearchedHouses[0];

            const startId = parseInt(initial?.id?.replace("hs", "")); // e.g., 18

            // Create a lookup map for existing hotspot IDs
            const existingIds = new Set(
              sliderSearchedHouses.map((house) =>
                parseInt(house?.id?.replace("hs", ""))
              )
            );

            // Find the maximum ID in sliderSearchedHouses to set loop bounds
            const maxId = Math.max(...Array.from(existingIds));

            // Filter and keep only sequential hotspots starting from startId
            const newHotspotArray = [];
            const missingHotspots = [];

            let allowedHotspots = newHotspotArray;

            // Get total number of hotspots
            const hotspotCount = krpano.get("hotspot.count");

            sliderSearchedHouses.forEach((data) => {
              allowedHotspots.push(data.id);
            });

            const zoneTotalLength = totalLength(currentScene);

            // Iterate through all hotspots in the current scene and hide them by default
            for (let i = 0; i < zoneTotalLength; i++) {
              const hotspotName = krpano.get(`hotspot[${i}].name`);
              if (hotspotName) {
                // Ensure hotspotName exists
                //

                krpano.set(`hotspot[${hotspotName}].border`, false);
                krpano.set(`hotspot[${hotspotName}].borderwidth`, 0); // Hide border
                krpano.set(`hotspot[${hotspotName}].borderalpha`, 0);

                //  krpano.set(`hotspot[${hotspotName}].bordercolor`, "0x000000");
              }
            }

            reSetHotspots();
            reDrawAvailableHotspots(allowedHotspots);
          }

          allowedHotspots = [];

          displayHorizontalSlider();
          // handleSearchFilters();
        };

        const reSetHotspots = () => {
          const krpano = document.getElementById("krpanoSWFObject");

          const currentScene = krpano.get("xml.scene");

          switch (currentScene) {
            case "scene_c-zone_1":
              disappearZoneData(zone1houseData, "", krpano);
              break;

            case "scene_d-zone_2":
              disappearZoneData(zone2houseData, "", krpano);
              break;

            case "scene_e-zone_3":
              disappearZoneData(zone3houseData, "", krpano);
              break;

            case "scene_i-building_2":
              disappearZoneData(building2houseData, "", krpano);

              break;

            case "scene_h-building_1":
              disappearZoneData(building1houseData, "", krpano);

              break;

            case "scene_f-zone_4":
              disappearZoneData(zone7houseData, "", krpano);
              break;

            case "scene_g-zone_5":
              console.log("HERE IT IS  ZONE 5");
              disappearZoneData(zone8houseData, "", krpano);
              break;

            case "scene_k_zone_9":
              disappearZoneData(zone9houseData, "", krpano);

              break;

            default:
              break;
          }
        };

        const reDrawAvailableHotspots = (allowedHotspots) => {
          // Filter zone8houseData by allowedHotspots

          const krpano = document.getElementById("krpanoSWFObject");
          const currentScene = krpano.get("xml.scene");

          switch (currentScene) {
            case "scene_c-zone_1":
              const filteredzone1houseData = zone1houseData.filter((hotspot) =>
                allowedHotspots.includes(hotspot.id)
              );

              dynamicZoneRendering(filteredzone1houseData, "", krpano);
              break;

            case "scene_d-zone_2":
              const filteredzone2houseData = zone2houseData.filter((hotspot) =>
                allowedHotspots.includes(hotspot.id)
              );

              dynamicZoneRendering(filteredzone2houseData, "", krpano);

              break;

            case "scene_e-zone_3":
              const filteredzone3houseData = zone3houseData.filter((hotspot) =>
                allowedHotspots.includes(hotspot.id)
              );

              dynamicZoneRendering(filteredzone3houseData, "", krpano);

              break;

            case "scene_i-building_2":
              const filteredBuilding2houseData = building2houseData.filter(
                (hotspot) => allowedHotspots.includes(hotspot.id)
              );

              dynamicZoneRendering(filteredBuilding2houseData, "", krpano);

              break;

            case "scene_h-building_1":
              const filteredBuilding1houseDataData = building1houseData.filter(
                (hotspot) => allowedHotspots.includes(hotspot.id)
              );

              dynamicZoneRendering(filteredBuilding1houseDataData, "", krpano);

              break;

            case "scene_f-zone_4":
              const filteredZone7Data = zone7houseData.filter((hotspot) =>
                allowedHotspots.includes(hotspot.id)
              );

              dynamicZoneRendering(filteredZone7Data, "", krpano);

              // dynamicZoneRendering(filteredZone7Data, "", krpano);
              break;

            case "scene_g-zone_5":
              const filteredZone8Data = zone8houseData.filter((hotspot) =>
                allowedHotspots.includes(hotspot.id)
              );

              dynamicZoneRendering(filteredZone8Data, "", krpano);

              break;

            case "scene_k_zone_9":
              const filteredZone9Data = zone9houseData.filter((hotspot) =>
                allowedHotspots.includes(hotspot.id)
              );

              dynamicZoneRendering(filteredZone9Data, "", krpano);

              break;

            default:
              break;
          }
        };

        let slidersHotspot = [];

        let currentAppearingHotpsots = [];
        function handleHoverIn(id, ath, atv) {
          blinkIndividualHotspot(id, true);
          flyToHouse(ath, atv);
        }

        function handleHoverOut(element) {
          blinkIndividualHotspot("", false, true);
        }
       
        const displayHorizontalSlider = () => {
          const sliderContainer = document.querySelector(".card-slider_1");
          sliderContainer.innerHTML = ""; // Clear previous content if needed

          sliderSearchedHouses &&
            sliderSearchedHouses.forEach((house, index) => {
              const cords = house ? house?.coordinates[0] : "";
              const cardHTML = `
  <div class="card-wrapper" > <div class="top-label-box"> Price: TBD </div>
        <div class="card_1" 
         onmouseover="handleHoverIn('${house.id}', '${cords.ath}', '${cords.atv}')" 
  onmouseout="handleHoverOut(this)"
        
        onclick="showIndividualHouseCard('${house.plot_number}','${house.id}' )">
        
            <img src='${dynamicSliderImage(house.total_area)}' height="100px" width="100px" />
            <div class="details_1">
                <h4>Plot ${house.plot_number}</h4>
                 
                <aside>
                  <i class="fa fa-map-marker mr-2"></i>  
                  
                   <span class="zone">${house.zone}</span>, Al Marina
               
                  
                  
                  </aside>
                <div class="property-info_1">
                    <div class="info-item_1">
                        <span class="label_1">  Area</span>
                        <span class="value">${house.total_area} m²</span>
                    </div>
                    <div class="info-item_1">
                        <span class="label_1">Availibility</span>
                        <span class="value">Available</span>
                    </div>
                    <div class="info-item_1">
                        </div>
                </div>
         
            </div>
        </div>
    </div>
    `;

              house &&
                sliderContainer.insertAdjacentHTML("beforeend", cardHTML);
            });

          // 🔁 Recalculate toggle margin after content is injected
        };

        const createSceneCard = () => {
          const krpano = document.getElementById("krpanoSWFObject");
          if (!krpano || typeof krpano.get !== "function") return;

          const currentScene = krpano.get("xml.scene");

          let wrapper = document.getElementById("scene-card-wrapper");

          if (currentScene === "scene_a-initial") {
            if (!wrapper) {
              wrapper = document.createElement("div");
              wrapper.id = "scene-card-wrapper";
              wrapper.innerHTML = `
        <div id="scene-card" onclick="arialView()">
          <div class="scene-card-content">
            <img src="skin/icons/AlMarinaLogo_big.png" width="50%" height="50%" class="breadcrumb-icon" />
          
          </div>
        </div>
      `;
              // document.body.appendChild(wrapper);
            } else {
              wrapper.style.display = "block"; // re-show if hidden
            }
          } else {
            // Hide if card exists
            if (wrapper) wrapper.style.display = "none";
          }
        };

        let block_number = "";

        let breadcrumbTrail = [
          {
            scene: "scene_a-initial",
            title: "",
            icon: '<div><img src="skin/icons/erth_logo_white.png" width="100px" height="100px" class="breadcrumb-icon" /></div>',
          },
        ];

        // Mapping scene to readable name (if needed)
        const sceneTitleMap = {
          "scene_b-AL_MARINA_aerial": { title: "Al Marina", icon: "home" },

          // Add more mappings here
        };

        const updateSearchVisibility = () => {
          var krpano_obj = document.getElementById("krpanoSWFObject");
          const zoomLevel = krpano_obj.get("view.fov");

          const searchBar = document.getElementById("searchBarContainer");
          const mobileSearchCard =
            document.getElementById("mobileSearchFilter");

          const searchSliderFilters = document.getElementById(
            "searchSliderFilters"
          );
          const mobileSearchFilter =
            document.getElementById("mobileSearchFilter");

          sliderSearchedHouses = [];
          clearSliderRange();

          const sceneCardWrapper =
            document.getElementById("scene-card-wrapper");

          const topButton360 = document.getElementById("top-button-360");

          //scene-card-wrapper

          const krpano = document.getElementById("krpanoSWFObject");
          if (!krpano || typeof krpano.get !== "function") return;

          const currentScene = krpano.get("xml.scene");

          const width = window.innerWidth;

          if (
            String(currentScene).includes("_360") ||
            currentScene === "scene_13-180m" ||
            currentScene === "future_scene_13-180m"
          ) {
            topButton360.style.display = "block";
          } else {
            topButton360.style.display = "none";
          }

          if (
            currentScene === "scene_a-initial" ||
            currentScene === "scene_b-al_marina_aerial" ||
            currentScene === "scene_13-180m" ||
            currentScene === "future_scene_13-180m" ||
            String(currentScene).includes("_360")
          ) {
            searchBar.style.display = "none";
            searchSliderFilters.style.display = "none";
            mobileSearchFilter.style.display = "none";
            mobileSearchCard.style.display = "none";
          } else {
            searchBar.style.display = "block";
            searchSliderFilters.style.display = "block";
            mobileSearchCard.style.display = "block";
            if (width < 770) {
              // mobileSearchFilter.style.display = "block";
            }
            //
          }
        };

        const checkRecordExistence = (zoneData, value) => {
          if (value) {
            const filteredData = zoneData?.filter(
              (unit) => unit.plot_number === value
            );

            if (!filteredData.length) {
              document.getElementById("notFoundModal").style.display = "block";
            } else {
              document.getElementById("notFoundModal").style.display = "none";
            }
          }
        };

        const closeModal = () => {
          document.getElementById("notFoundModal").style.display = "none";
        };

        function toggleClearIcon(input) {
          const clearIcon = document.getElementById("clearIcon");
          clearIcon.style.display = input.value ? "block" : "none";
          //blinkHotspot(false); // Stop blinking when input changes
        }

        function clearSearch() {
          const searchBox = document.getElementById("searchBox");
          searchBox.value = "";
          document.getElementById("clearIcon").style.display = "none";
          // handleSearch(''); // optional: re-trigger search with empty value
        }

        let currentBlinkInterval = null;
        let currentBlinkingHotspot = null;

        //sliderSearchedHouses
        function onSceneChange(currentScene, Unit) {
          const unitData = localStorage.getItem("response");
          const parsedData = JSON.parse(unitData);

          const krpano = document.getElementById("krpanoSWFObject");

          if (Unit.zone === "ZONE 1") {
            // Load the corresponding scene

            krpano.call(
              `loadscene(${"scene_c-zone_1"}, null, MERGE, BLEND(1))`
            );
          }

          if (currentScene === "scene_b-al_marina_aerial") {
            const Unit = parsedData.data.find(
              (house) =>
                house.plot_number === value || house.total_area === value
            );

            if (Unit.zone === "ZONE 1") {
              // Load the corresponding scene

              krpano.call(
                `loadscene(${"scene_c-zone_1"}, null, MERGE, BLEND(1))`
              );
            } else if (Unit.zone === "ZONE 2") {
              krpano.call(
                `loadscene(${"scene_e-zone_3"}, null, MERGE, BLEND(1))`
              );
            } else if (Unit.zone === "ZONE 3") {
              krpano.call(
                `loadscene(${"scene_al_marina_zone_3"}, null, MERGE, BLEND(1))`
              );
            } else if (Unit.zone === "ZONE 7") {
              krpano.call(
                `loadscene(${"scene_f-zone_4"}, null, MERGE, BLEND(1))`
              );
            } else if (Unit.zone === "ZONE 5") {
              krpano.call(
                `loadscene(${"scene_g-zone_5"}, null, MERGE, BLEND(1))`
              );
            } else if (Unit.zone === "ZONE 6") {
              krpano.call(
                `loadscene(${"scene_h-building_1"}, null, MERGE, BLEND(1))`
              );
            } else if (Unit.zone === "ZONE 7") {
              krpano.call(
                `loadscene(${"scene_i-building_2"}, null, MERGE, BLEND(1))`
              );
            }
          } else {
            // Handle other scenes here...
          }
        }

        function getSpecificUnit() {
          const area = document.getElementById("totalArea").value;

          const unitData = localStorage.getItem("response");

          const plot = document.getElementById("plotNumber").value;

          let parsedData;
          let unit;
          if (unitData && unitData !== "undefined") {
            try {
              parsedData = JSON.parse(unitData);

              unit = parsedData.data.find(
                (house) => (house.plot_number = plot)
              );
            } catch (error) {
              console.error("❌ Failed to parse unitData:", error);
            }
          } else {
            console.warn("⚠️ No valid unit data found in localStorage.");
          }

          return unit;
        }

        const getParsedData = () => {
          const unitData = localStorage.getItem("response");
          const parsedData = JSON.parse(unitData);
          return parsedData;
        };

        const zoneOneFilteredData = () => {
          const parsedData = getParsedData();
          return parsedData.data.filter((house) => house.zone === "ZONE 1");
        };

        const zoneTwoFilteredData = () => {
          const parsedData = getParsedData();
          return parsedData.data.filter((house) => house.zone === "ZONE 2");
        };
        const zoneThreeFilteredData = () => {
          const parsedData = getParsedData();
          return parsedData.data.filter((house) => house.zone === "ZONE 3");
        };

        const zoneFourFilteredData = () => {
          const parsedData = getParsedData();
          return parsedData.data.filter((house) => house.zone === "ZONE 4");
        };

        const zoneFiveFilteredData = () => {
          const parsedData = getParsedData();
          return parsedData.data.filter((house) => house.zone === "ZONE 5");
        };

        const zoneSixFilteredData = () => {
          const parsedData = getParsedData();
          return parsedData.data.filter((house) => house.zone === "ZONE 6");
        };

        const zoneSevenFilteredData = () => {
          const parsedData = getParsedData();
          return parsedData.data.filter((house) => house.zone === "ZONE 7");
        };

        const zoneEightFilteredData = () => {
          const parsedData = getParsedData();
          return parsedData.data.filter((house) => house.zone === "ZONE 8");
        };

        const zoneNineFilteredData = () => {
          const parsedData = getParsedData();
          return parsedData.data.filter((house) => house.zone === "ZONE 9");
        };

        function clearSliderRange() {
          const slider = document.getElementById("totalArea");
          slider.min = 100;
          slider.max = 20000;

          sliderSearchedHouses = [];
          displayHorizontalSlider();
        }

        let latestArrayZone1 = [],
          latestArrayZone2 = [],
          latestArrayZone3 = [],
          latestArrayZone4 = [],
          latestArrayZone6 = [];
        latestArrayZone5 = [];
        latestArrayZone9 = [];
        (latestArrayZone7 = []), (latestArrayZone8 = []);

        function getSpeificUnitsByArea() {
          const area = document.getElementById("totalArea").value;
          const unitData = localStorage.getItem("response");
          const parsedData = JSON.parse(unitData);
          previouslyVisibleHotspots = [];
          const krpano = document.getElementById("krpanoSWFObject");
          let currentScene = krpano.get("xml.scene"); // Gets the currently loaded scene name
          let zone;
          let filteredHouses;
          let matchedZone;
          (latestArrayZone1 = []),
            (latestArrayZone2 = []),
            (latestArrayZone3 = []),
            (latestArrayZone6 = []);
          latestArrayZone5 = [];
          latestArrayZone9 = [];
          (latestArrayZone7 = []), (latestArrayZone8 = []);

          const zone3 = parsedData.data.filter(
            (house) => house.zone === "ZONE 3"
          );
          const zone7 = parsedData.data.filter(
            (house) => house.zone === "ZONE 7"
          );

          if (area) {
            document.getElementById("areaValue").textContent = `100 sq m`;

            document.getElementById("areaMax").textContent = `20000`;

            document.getElementById("mobileAreaValue").textContent = `100 sq m`;
            document.getElementById("mobileAreaMax").textContent = `20000`;

            console.log("currentScene", currentScene);
            switch (currentScene) {
              case "scene_c-zone_1":
                updateSliderRange("1");
                const updatedZone1houseData = zoneOneFilteredData().map(
                  (house) => {
                    matchedZone = zone1houseData.find(
                      (zone) =>
                        parseInt(house.plot_number) ===
                        parseInt(zone.plot_number)
                    );

                    latestArrayZone1.push({
                      ...house,
                      total_area: house?.total_area,
                      id: matchedZone?.id,
                      coordinates: matchedZone?.coordinates
                        ? matchedZone?.coordinates
                        : [{ ath: 0, atv: 0 }],
                    });
                  }
                );
                filteredHouses = latestArrayZone1.filter(
                  (house) => parseInt(house.total_area) <= parseFloat(area)
                );

                break;

              case "scene_d-zone_2":
                updateSliderRange("2");

                const updatedZone2houseData = zoneTwoFilteredData().map(
                  (house) => {
                    matchedZone = zone2houseData.find(
                      (zone) =>
                        parseInt(house.plot_number) ===
                        parseInt(zone.plot_number)
                    );

                    latestArrayZone2.push({
                      ...house,
                      total_area: house?.total_area,
                      id: matchedZone?.id,

                      coordinates: matchedZone?.coordinates
                        ? matchedZone?.coordinates
                        : [{ ath: 0, atv: 0 }],
                    });
                  }
                );
                filteredHouses = latestArrayZone2.filter(
                  (house) => parseFloat(house.total_area) <= parseFloat(area)
                );
                break;
              case "scene_e-zone_3":
                updateSliderRange("3");
                const updatedZone3houseData = zoneThreeFilteredData().map(
                  (house) => {
                    matchedZone = zone3houseData.find(
                      (zone) =>
                        parseInt(house.plot_number) ===
                        parseInt(zone.plot_number)
                    );

                    latestArrayZone3.push({
                      ...house,
                      total_area: house?.total_area,
                      id: matchedZone?.id,
                      coordinates: matchedZone?.coordinates
                        ? matchedZone?.coordinates
                        : [{ ath: 0, atv: 0 }],
                    });
                  }
                );

                filteredHouses = latestArrayZone3.filter(
                  (house) => parseFloat(house.total_area) <= parseFloat(area)
                );
                break;

              case "scene_i-building_2":
                updateSliderRange("5");

                const updatedbuilding2houseData = zoneFiveFilteredData().map(
                  (house) => {
                    matchedZone = building2houseData.find(
                      (zone) =>
                        parseInt(house.plot_number) ===
                        parseInt(zone.plot_number)
                    );

                    latestArrayZone5.push({
                      ...house,
                      total_area: house?.total_area,
                      id: matchedZone?.id,
                      coordinates: matchedZone?.coordinates
                        ? matchedZone?.coordinates
                        : [{ ath: 0, atv: 0 }],
                    });
                  }
                );

                filteredHouses = latestArrayZone5.filter(
                  (house) => parseFloat(house.total_area) <= parseFloat(area)
                );

                break;
              case "scene_h-building_1":
                updateSliderRange("6");

                const updatedbuilding1houseData = zoneSixFilteredData().map(
                  (house) => {
                    matchedZone = building1houseData.find(
                      (zone) =>
                        parseInt(house.plot_number) ===
                        parseInt(zone.plot_number)
                    );

                    latestArrayZone6.push({
                      ...house,
                      total_area: house?.total_area,
                      id: matchedZone?.id,
                      coordinates: matchedZone?.coordinates
                        ? matchedZone?.coordinates
                        : [{ ath: 0, atv: 0 }],
                    });
                  }
                );
                filteredHouses = latestArrayZone6.filter(
                  (house) => parseFloat(house.total_area) <= parseFloat(area)
                );
                break;

              case "scene_l_al_marina_mall_day_aerial":
                updateSliderRange("4");
                const updatedZone4houseData = zoneFourFilteredData().map(
                  (house) => {
                    matchedZone = zone4houseData.find(
                      (zone) =>
                        parseInt(house.plot_number) ===
                        parseInt(zone.plot_number)
                    );

                    latestArrayZone4.push({
                      ...house,
                      total_area: house?.total_area,
                      id: matchedZone?.id,
                      coordinates: matchedZone?.coordinates
                        ? matchedZone?.coordinates
                        : [{ ath: 0, atv: 0 }],
                    });
                  }
                );
                filteredHouses = latestArrayZone4.filter(
                  (house) => parseFloat(house.total_area) <= parseFloat(area)
                );
                break;

              case "scene_f-zone_4":
                updateSliderRange("7");
                const updatedZone7houseData = zoneSevenFilteredData().map(
                  (house) => {
                    matchedZone = zone7houseData.find(
                      (zone) =>
                        parseInt(house.plot_number) ===
                        parseInt(zone.plot_number)
                    );

                    latestArrayZone7.push({
                      ...house,
                      total_area: house?.total_area,
                      id: matchedZone?.id,
                      coordinates: matchedZone?.coordinates
                        ? matchedZone?.coordinates
                        : [{ ath: 0, atv: 0 }],
                    });
                  }
                );
                filteredHouses = latestArrayZone7.filter(
                  (house) => parseFloat(house.total_area) <= parseFloat(area)
                );
                break;
              case "scene_g-zone_5":
                updateSliderRange("8");

                const updatedZone8houseData = zoneEightFilteredData().map(
                  (house) => {
                    matchedZone = zone8houseData.find(
                      (zone) =>
                        parseInt(house.plot_number) ===
                        parseInt(zone.plot_number)
                    );

                    latestArrayZone8.push({
                      ...house,
                      total_area: house?.total_area,
                      id: matchedZone?.id,
                      coordinates: matchedZone?.coordinates
                        ? matchedZone?.coordinates
                        : [{ ath: 0, atv: 0 }],
                    });
                  }
                );

                filteredHouses = latestArrayZone8.filter(
                  (house) => parseFloat(house.total_area) <= parseFloat(area)
                );
                break;

              case "scene_k_zone_9":
                updateSliderRange("9");
                const updatedZone9houseData = zoneNineFilteredData().map(
                  (house) => {
                    matchedZone = zone9houseData.find(
                      (zone) =>
                        parseInt(house.plot_number) ===
                        parseInt(zone.plot_number)
                    );

                    latestArrayZone9.push({
                      ...house,
                      total_area: house?.total_area,
                      id: matchedZone?.id,
                      coordinates: matchedZone?.coordinates
                        ? matchedZone?.coordinates
                        : [{ ath: 0, atv: 0 }],
                    });
                  }
                );
                filteredHouses = latestArrayZone9.filter(
                  (house) => parseFloat(house.total_area) <= parseFloat(area)
                );

                break;

              default:
                break;
            }
          }

          return filteredHouses;
        }

        const handleSearchFilters = () => {
          const plot = document.getElementById("plotNumber").value;
          const area = document.getElementById("totalArea").value;
          const krpano = document.getElementById("krpanoSWFObject");

          // // 👉 Stop previous blinking

          blinkIndividualHotspot("", false, true);
          if (area) {
            // Stop previous blinking first
            stopAllBlinkingHotspots();

            const areaHouses = getSpeificUnitsByArea();

            areaHouses.forEach((house) => {
              const hotspotName = `${house.id}`;
              // blinkHotspot(hotspotName);

              previouslyVisibleHotspots.push({ id: hotspotName });
            });
          }

          const unitData = localStorage.getItem("response");
          const parsedData = JSON.parse(unitData);

          let matchedHouse;

          currentScene = krpano.get("xml.scene");
          // onSceneChange(currentScene, unit)

          switch (currentScene) {
            case "scene_b-al_marina_aerial":
              matchedHouse = null;

              break;
            case "scene_c-zone_1":
              matchedHouse = zone1houseData.find(
                (house) => house.plot_number === plot
              );

              checkRecordExistence(zone1houseData, plot);

              break;
            case "scene_d-zone_2":
              matchedHouse = zone2houseData.find(
                (house) => house.plot_number === plot
              );
              checkRecordExistence(zone2houseData, plot);
              break;
            case "scene_e-zone_3":
              matchedHouse = zone3houseData.find(
                (house) => house.plot_number === plot
              );
              checkRecordExistence(zone3houseData, plot);
              break;

            case "scene_f-zone_4":
              matchedHouse = zone7houseData.find(
                (house) => house.plot_number === plot
              );

              checkRecordExistence(zone7houseData, plot);

              break;

            case "scene_g-zone_5":
              matchedHouse = zone8houseData.find(
                (house) => house.plot_number === plot
              );
              checkRecordExistence(zone8houseData, plot);
              break;

            case "scene_h-building_1":
              matchedHouse = building1houseData.find(
                (house) => house.plot_number === plot
              );
              checkRecordExistence(building1houseData, plot);
              break;

            case "scene_i-building_2":
              matchedHouse = building2houseData.find(
                (house) => house.plot_number === plot
              );

              checkRecordExistence(building2houseData, plot);
              break;

            case "scene_k_zone_9":
              matchedHouse = zone9houseData.find(
                (house) => house.plot_number === plot
              );

              checkRecordExistence(zone9houseData, plot);
              break;

            case "scene_l_al_marina_mall_day_aerial":
              matchedHouse = zone4houseData.find(
                (house) => house.plot_number === plot
              );

              checkRecordExistence(zone4houseData, plot);
              break;

            // You can add more zones here if needed
            default:
              matchedHouse = null;
              break;
          }

          const hotspotName = `${matchedHouse?.id}`;
          if (matchedHouse) {
            // blinkHotspot(hotspotName);

            blinkIndividualHotspot(hotspotName, true);

            let center = matchedHouse.coordinates?.[0]; // Default to first
            if (
              matchedHouse.coordinates &&
              matchedHouse.coordinates.length > 1
            ) {
              const total = matchedHouse.coordinates.reduce(
                (acc, point) => {
                  acc.ath += parseFloat(point.ath);
                  acc.atv += parseFloat(point.atv);
                  return acc;
                },
                { ath: 0, atv: 0 }
              );
              center = {
                ath: total.ath / matchedHouse.coordinates.length,
                atv: total.atv / matchedHouse.coordinates.length,
              };
            }

            const filteredData = parsedData?.data?.filter(
              (unit) => unit.plot_number === plot
            );

            if (unitData && unitData.length > 0) {
              createCard(
                "Title",
                "Description",
                "https://via.placeholder.com/150",
                filteredData
              );
            }

            krpano.call(
              `lookto(${center?.ath}, ${center?.atv}, 90, smooth());`
            );
          } else {
            closeCard(); // Close any existing card

            // Stop blinking and reset color if a previous hotspot was blinking
          }

          // You can replace alert with your own search logic
        };

        const findMaximumAndMinimum = (zoneData) => {
          if (!zoneData || zoneData.length === 0) {
            return;
          }

          let maxArea = parseInt(zoneData[0].total_area);
          let minArea = parseInt(zoneData[0].total_area);

          for (let i = 0; i < zoneData.length; i++) {
            const currentArea = parseInt(zoneData[i].total_area);

            if (currentArea > maxArea) {
              maxArea = currentArea;
            }

            if (currentArea < minArea) {
              minArea = currentArea;
            }
          }

          return { max: maxArea, min: minArea };
        };

        let hasSetSliderOnce = false; // Global or outer scoped

        function updateSliderRange(zoneNumber) {
          let zoneHouses = [];

          switch (zoneNumber) {
            case "1":
              zoneHouses = zoneOneFilteredData();
              break;
            case "2":
              zoneHouses = zoneTwoFilteredData();
              break;

            case "3":
              zoneHouses = zoneThreeFilteredData();
              break;

            case "4":
              zoneHouses = zoneFourFilteredData();
              break;

            case "5":
              zoneHouses = zoneFiveFilteredData();

              break;

            case "6":
              zoneHouses = zoneSixFilteredData();
              break;

            case "7":
              zoneHouses = zoneSevenFilteredData();
              break;

            case "8":
              zoneHouses = zoneEightFilteredData();
              break;

            case "9":
              zoneHouses = zoneNineFilteredData();
              break;
            // add more cases for other zones
          }

          const { min, max } = findMaximumAndMinimum(zoneHouses);

          // Update slider attributes
          const slider = document.getElementById("totalArea");

          slider.min = min;
          slider.max = max.toString();

          console.log("MINIMUM", min, "MAXIUM", max, slider.value);

          // Update labels
          document.getElementById("areaValue").textContent = `${slider.value}`;
          document.getElementById("areaMax").textContent = `${max}`;

          document.getElementById(
            "mobileAreaValue"
          ).textContent = `${slider.value}`;
          document.getElementById("mobileAreaMax").textContent = `${max}`;
        }

        // Globals (declare these outside your function, at top level)
        let currentBlinkingHotspotsByArea = [];
        let currentBlinkIntervalsByArea = [];

        const stopAllBlinkingHotspots = () => {
          const krpano = document.getElementById("krpanoSWFObject");
          if (currentBlinkIntervalsByArea.length > 0) {
            currentBlinkIntervalsByArea.forEach((interval, i) => {
              clearInterval(interval);
              const hotspotName = currentBlinkingHotspotsByArea[i];
              krpano.call(`set(hotspot[${hotspotName}].fillcolor, 0x39FF14)`);
            });

            krpano.call(
              `set(hotspot[${hotspotName}].fillalpha, 0.2)` // reset to default or less visible
            );
            currentBlinkingHotspotsByArea = [];
            currentBlinkIntervalsByArea = [];
          }
        };

        const blinkIndividualHotspot = (
          hotspotName,
          isShow = false,
          isHide = false
        ) => {
          const krpano = document.getElementById("krpanoSWFObject");

          // Stop blinking (on close or switching to aerial scene)
          if (
            isHide ||
            !hotspotName ||
            krpano.get("xml.scene") === "scene_b-al_marina_aerial"
          ) {
            if (currentBlinkInterval && currentBlinkingHotspot) {
              clearInterval(currentBlinkInterval);
              krpano.call(
                `set(hotspot[${currentBlinkingHotspot}].fillcolor, 0x39FF14)`
              ); // Reset color
              krpano.call(
                `set(hotspot[${currentBlinkingHotspot}].fillalpha, 0.2)` // reset to default or less visible
              );
              currentBlinkInterval = null;
              currentBlinkingHotspot = null;
            }
            return;
          }

          const ath = krpano.get(`hotspot[${currentBlinkingHotspot}].ath`);
          const atv = krpano.get(`hotspot[${currentBlinkingHotspot}].atv`);

          if (isShow) {
            if (currentBlinkInterval && currentBlinkingHotspot) {
              clearInterval(currentBlinkInterval);
              krpano.call(
                `set(hotspot[${currentBlinkingHotspot}].fillcolor, 0x39FF14)`
              );
              krpano.call(
                `set(hotspot[${currentBlinkingHotspot}].fillalpha, 0.2)` // reset to default or less visible
              );

              currentBlinkInterval = null;
              currentBlinkingHotspot = null;
            }

            // Start blinking for new hotspot
            const blinkColors = ["0x39FF14", "0xE87281"];
            let blinkIndex = 0;

            currentBlinkInterval = setInterval(() => {
              const color = blinkColors[blinkIndex];
              krpano.call(`set(hotspot[${hotspotName}].fillcolor, ${color})`);
              krpano.call(`set(hotspot[${hotspotName}].fillalpha, 0.4)`); // increase opacity
              blinkIndex = (blinkIndex + 1) % blinkColors.length;
            }, 500);

            currentBlinkingHotspot = hotspotName;
          }
        };

        const blinkInitialSateliteBlinking = () => {
          let krpano = globalKrpano();
          const blinkColors = ["0xD8C8B0  ", "0xa65c43"];
          let blinkIndex = 0;

          interval = setInterval(() => {
            const color = blinkColors[blinkIndex];

            krpano.call(
              `set(hotspot[${"hs_Marina_Arial"}].bordercolor, ${color})`
            );
            blinkIndex = (blinkIndex + 1) % blinkColors.length;
          }, 650);
        };
        blinkInitialSateliteBlinking();

        function blinkHotspot(hotspotName, isShow) {
          const krpano = document.getElementById("krpanoSWFObject");

          let currentScene = krpano.get("xml.scene");

          // Case 1: If we're back at the aerial scene or hotspotName is false — stop everything
          if (currentScene === "scene_b-al_marina_aerial" || !hotspotName) {
            if (currentBlinkInterval && currentBlinkingHotspot) {
              clearInterval(currentBlinkInterval);

              // Reset color of the previous hotspot
              krpano.call(
                `set(hotspot[${currentBlinkingHotspot}].fillcolor, 0x39FF14)`
              );

              // Clear references
              currentBlinkInterval = null;
              currentBlinkingHotspot = null;
            }

            return;
          }

          // Case 2: Stop any previous blinking before starting new one

          const area = document.getElementById("totalArea").value;

          const plot = document.getElementById("plotNumber").value;

          let previousArea;

          if (!area) {
            if (currentBlinkInterval && currentBlinkingHotspot) {
              clearInterval(currentBlinkInterval);
              krpano.call(
                `set(hotspot[${currentBlinkingHotspot}].fillcolor,  0x39FF14)`
              );

              krpano.call(
                `set(hotspot[${currentBlinkingHotspot}].fillaplha, 0.2)`
              );

              currentBlinkingHotspot = null;
              currentBlinkInterval = null;
            }

            previousArea = area;
          }

          if (area) {
            // Case 3: Start blinking for the new hotspot
            const blinkColors = ["0x39FF14", "0xFFA500"];
            let blinkIndex = 0;

            interval = setInterval(() => {
              const color = blinkColors[blinkIndex];

              krpano.call(`set(hotspot[${hotspotName}].fillcolor, ${color})`);
              blinkIndex = (blinkIndex + 1) % blinkColors.length;
            }, 500);

            currentBlinkingHotspotsByArea.push(hotspotName);
            currentBlinkIntervalsByArea.push(interval);
          }

          if (plot) {
            if (currentBlinkInterval && currentBlinkingHotspot) {
              clearInterval(currentBlinkInterval);
              krpano.call(
                `set(hotspot[${currentBlinkingHotspot}].fillcolor,  0x39FF14)`
              );

              currentBlinkingHotspot = null;
              currentBlinkInterval = null;
            }

            // Case 3: Start blinking for the new hotspot
            const blinkColors = ["0x39FF14", "0xFFA500"];
            let blinkIndex = 0;

            currentBlinkInterval = setInterval(() => {
              const color = blinkColors[blinkIndex];

              krpano.call(`set(hotspot[${hotspotName}].fillcolor, ${color})`);
              blinkIndex = (blinkIndex + 1) % blinkColors.length;
            }, 500);

            currentBlinkingHotspot = hotspotName;
          }
        }

        function toggleFullScreen() {
          const elem = document.documentElement;
          const btn = document.getElementById("fullScreenBtn");

          if (
            !document.fullscreenElement &&
            !document.webkitFullscreenElement &&
            !document.msFullscreenElement
          ) {
            // Enter fullscreen
            if (elem.requestFullscreen) {
              elem
                .requestFullscreen()
                .then(() => {
                  console.log("Fullscreen mode activated");
                })
                .catch((error) => {
                  console.error("Fullscreen mode failed:", error);
                });
            } else if (elem.webkitRequestFullscreen) {
              elem.webkitRequestFullscreen(); // Safari
            } else if (elem.msRequestFullscreen) {
              elem.msRequestFullscreen(); // IE11
            }

            btn.innerHTML = "🗗";
          } else {
            // Exit fullscreen
            if (document.exitFullscreen) {
              document.exitFullscreen();
            } else if (document.webkitExitFullscreen) {
              document.webkitExitFullscreen(); // Safari
            } else if (document.msExitFullscreen) {
              document.msExitFullscreen(); // IE11
            }
            btn.innerHTML = "⛶";
          }
        }

        const resetTimelineState = () => {
          const timeToggle = document.querySelector(".time-toggle");
          const now = timeToggle.querySelector(".now");
          const future = timeToggle.querySelector(".future");
          now.classList.add("active");
          future.classList.remove("active");
        };

        const toggleTimeView = (clickedElement) => {
          const timeToggle = clickedElement.parentElement;
          const now = timeToggle.querySelector(".now");
          const future = timeToggle.querySelector(".future");

          const krpano = document.getElementById("krpanoSWFObject");
          const currentScene = krpano.get("xml.scene");
          console.log("Current Scene: ", currentScene);

          let originalString = currentScene;

          let newString = originalString.replace("future_", "");

          // Clear all active states
          now.classList.remove("active");
          future.classList.remove("active");

          const count = krpano.get("scene.count");
          // for (let i = 0; i < count; i++) {
          //   console.log(`Scene ${i}:`, krpano.get(`scene[${i}].name`));
          // }

          if (true) {
            if (clickedElement.classList.contains("now")) {
              // Move to Now
              now.classList.add("active");
              krpano.call(
                `loadscene(${newString}, null, null, BLEND(1,2,'easeInOutSine'))`
              );
              console.log("Now view");
            } else if (clickedElement.classList.contains("future")) {
              // Move to Future
              future.classList.add("active");
              krpano.call(
                `loadscene(future_${currentScene}, null, null, BLEND(1,2,'easeInOutSine'))`
              );
            }
          }
        };
        

        // Render the breadcrumbs dynamically
        const renderBreadcrumbs = () => {
          const wrapper = document.getElementById("breadcrumb-wrapper");
          wrapper.innerHTML = ""; // Clear previous breadcrumbs


          const params = new URLSearchParams(window.location.search);
         
          const plotNumber = params.get("plotNumber");

          //url.searchParams.delete("plotNumber");

          breadcrumbTrail.forEach((crumb, index) => {
          console.log("CRUMB", crumb, index)
           
            if (index !== 0) {
              // Add separator
              const separator = document.createElement("span");
              separator.className =
                "breadcrumb-separator mui-breadcrumb-separator";
              separator.innerHTML = "&gt;";
              wrapper.appendChild(separator);
            }

            

            console.log("CRUMB", crumb);

            // Build query string if available

            let queryString = "";
            
            if (crumb.scene && crumb.scene !== 'scene_a-initial') {
              console.log("crumb", crumb.title);
              queryString += `zone=${crumb.scene}`;
            }
            if (crumb.scene && crumb.scene !== 'scene_a-initial') {
              queryString += (queryString ? "&" : "") + `plotNumber=${plotNumber? plotNumber : ''}`;
            }
            let krpano = globalKrpano();

            if(breadcrumbTrail.length === 1){
              krpano.call("loadscene(scene_a-initial, null, MERGE);");
              queryString= ""
            }

           
            // Combine current URL with query string
            const href = queryString ? `?${queryString}` : "";

            const targetURL = href;
           
            // Update the browser URL without reloading
            window.history.pushState({}, "", targetURL);
            if (
              index !== breadcrumbTrail.length - 1 ||
              breadcrumbTrail.length === 1
            ) {
              // Not the last one - make it a link
              const link = document.createElement("a");
              // link.href = href;

              link.className = "breadcrumb-link mui-breadcrumb-link";
              link.setAttribute("data-scene", crumb.scene);
              link.setAttribute("data-index", index); // Save index for back navigation

              link.innerHTML = `<i class="material-icons mui-breadcrumb-icon">${
                !index ? crumb.icon : ""
              }</i> ${crumb.title}`;

              wrapper.appendChild(link);
            } else {
              // Last one - current breadcrumb
              const current = document.createElement("span");
              current.className = "breadcrumb-current mui-breadcrumb-current  ";

              current.innerHTML = `<i class="material-icons mui-breadcrumb-icon">${
                !index ? crumb.icon : ""
              }</i> ${crumb.title}`;

              wrapper.appendChild(current);
            }
          });

          attachBreadcrumbClickEvents(); // Re-attach click events
        };

        // Attach click listeners to breadcrumb links
        const attachBreadcrumbClickEvents = () => {
          const breadcrumbLinks = document.querySelectorAll(".breadcrumb-link");

          breadcrumbLinks.forEach((link) => {
            link.addEventListener("click", function (e) {
              e.preventDefault();
              const sceneName = this.getAttribute("data-scene");
              const crumbIndex = parseInt(this.getAttribute("data-index"));
              if (crumbIndex === 0) {
                event.preventDefault();
               
                window.location.href = 'https://www.zameengeomatics.com/public/Marina_Interactive_Masterplan/';
                //location.reload();
              } else {
                removeBreadCrumbItem(sceneName, crumbIndex);
              }
            });
          });
        };

        // Load a new scene and update breadcrumb trail
        const loadScene = (sceneName) => {
          // Example krpano call if available
          if (window.krpano) {
            krpano.call(`loadscene(${sceneName}, null, MERGE, BLEND(1))`);
          }

          // Find scene info
          const sceneInfo = sceneTitleMap[sceneName];
          if (sceneInfo) {
            breadcrumbTrail.push({
              scene: sceneName,
              title: sceneInfo.title,
              icon: sceneInfo.icon,
            });
            // renderBreadcrumbs();
          } else {
            console.warn("Scene title not found for:", sceneName);
          }
        };

        // Initial render
        document.addEventListener("DOMContentLoaded", function () {
          renderBreadcrumbs();
        });

        const removeBreadCrumbItem = (sceneName, crumbIndex) => {
          var krpano = document.getElementById("krpanoSWFObject");

          if (sceneName) {
            loadScene(sceneName);
            breadcrumbTrail = breadcrumbTrail.slice(0, crumbIndex + 1);
            renderBreadcrumbs();
            krpano.call(`loadscene(${sceneName}, null, MERGE, BLEND(1))`);
          }
        };

        // Initial render
        document.addEventListener("DOMContentLoaded", function () {
          renderBreadcrumbs();
        });

        const addCustomDivToHotspot = (hotspotName) => {
          var krpano = document.getElementById("krpanoSWFObject"); // Get krpano instance
          if (krpano) {
          } else {
            console.error("Krpano instance not found");
          }
        };

        // Function to  call the API and fetch data on inital load
        const onInitalLoad = async () => {
          const krpano = document.getElementById("krpanoSWFObject");
          if (!krpano) {
            console.error("Krpano not loaded yet.");
            return;
          }

          const apiData = await fetchAlMarinaData();

          if (!apiData) {
            return;
          }
          return apiData;
        };

        const parseHotspots = (xmlString) => {
          const parser = new DOMParser();
          const xmlDoc = parser.parseFromString(
            `<root>${xmlString}</root>`,
            "text/xml"
          ); // wrap in <root> to make it valid XML

          const hotspotElements = xmlDoc.getElementsByTagName("hotspot");
          const houseData = [];

          Array.from(hotspotElements).forEach((hotspot) => {
            const id = hotspot.getAttribute("name");
            const plot_number = hotspot.getAttribute("plot_number");
            const total_area = hotspot.getAttribute("total_area");
            // const block_number = hotspot.getAttribute("block_number");

            const points = Array.from(
              hotspot.getElementsByTagName("point")
            ).map((point) => ({
              ath: parseFloat(point.getAttribute("ath")),
              atv: parseFloat(point.getAttribute("atv")),
            }));

            houseData.push({
              id,
              plot_number,
              total_area,
              //  block_number,
              coordinates: points,
            });
          });

          return houseData;
        };

        let zone1houseData = parseHotspots(zone1hotspotXML);
        let zone2houseData = parseHotspots(zone2hotspotXML);
        let zone3houseData = parseHotspots(zone3hotspotXML);
        let zone4houseData = parseHotspots(zoneMallhotspotXML);
        let zone8houseData = parseHotspots(zone8hotspotXML);

        let building1houseData = parseHotspots(zone6_building_1_hotspotXML);

        let zone7houseData = parseHotspots(zone7hotspotXML);

        let building2houseData = parseHotspots(zone5_building_2_hotspotXML);

        let zone9houseData = parseHotspots(zone9hotspotXML);

        let toggleState = true; // Global state for toggling colors (false = color1, true = color2)
        let toggleColorOn = false;

        let hotspotsVisible = true;

        function toggleHotspotColor(color1 = "0xFF0000", color2 = "0x00FF00") {
          toggleColorOn = !toggleColorOn;

          hotspotsVisible = !hotspotsVisible;

          const krpano = document.getElementById("krpanoSWFObject");
          if (!krpano) {
            console.error("Krpano instance not found");
            return;
          }
          const icon = document.getElementById("toggle-icon");
          const button = document.getElementById("toggle-button");

          icon.textContent = toggleColorOn ? "toggle_on" : "toggle_off";

          icon.style.color = toggleColorOn ? "#808e92  " : "#dee2e6";

          const totalHotspots = krpano.get("hotspot.count");
          for (let i = 0; i < totalHotspots; i++) {
            const hsName = krpano.get(`hotspot[${i}].name`);
            krpano.set(`hotspot[${hsName}].visible`, hotspotsVisible);
          }

          if (!toggleState) {
            icon.textContent = "toggle_on"; // icon change
            icon.style.color = "#a65c43"; // green
            // button.style.backgroundColor = "#e0f2f1"; // optional
          } else {
            icon.textContent = "toggle_off";
            button.style.backgroundColor = "transparent"; // reset
          }

          // Toggle the state for next change
          toggleState = !toggleState;
        }

        const updateToggleMarginBasedOnSlider = () => {
          setTimeout(() => {
            const searchSliderFilters = document.getElementById(
              "searchSliderFilters"
            );
            const toggleWrapper = document.querySelector("#controls");

            if (
              searchSliderFilters &&
              window.getComputedStyle(searchSliderFilters).display !== "none"
            ) {
              toggleWrapper.style.bottom = "15%";
            } else {
              toggleWrapper.style.bottom = "2%";
            }
          }, 1200); // Delay: 1200ms is usually enough to wait for DOM updates
        };

        window.addEventListener("load", updateToggleMarginBasedOnSlider);

        function getRandomColor() {
          const letters = "0123456789ABCDEF";
          let color = "#";
          for (let i = 0; i < 6; i++) {
            color += letters[Math.floor(Math.random() * 16)];
          }
          return "0x00FF00";
        }

        const dynamicZoneRendering = (zoneData, response, krpano) => {
          resetTimelineState();

          zoneData.forEach((house) => {
            // Create a unique name for each house hotspot
            const hotspotName = `hs_${house.id}`;

            const hotspotColor = getRandomColor();
            const hotspotColorHex = hotspotColor.replace("#", "0x");
            // Generate hotspot with points dynamically
            let hotspotXML = `<hotspot name="${hotspotName}" style="mypolygonalhotspotstylename">`;

            house.coordinates.forEach((point) => {
              hotspotXML += `<point ath="${point.ath}" atv="${point.atv}" />`;
            });
            hotspotXML += `</hotspot>`;

            const cords = house.coordinates[0];
            //        set(hotspot[${currentBlinkingHotspot}].fillcolor, 0xFFFF00);
            // Add hotspot to Krpano dynamically
            krpano.call(`addhotspot(${hotspotName})`);

            krpano.call(`
 
            
             
                set(hotspot[${hotspotName}].fillalpha, 0.2);
                set(hotspot[${hotspotName}].bordercolor, 0x39FF14);
                set(hotspot[${hotspotName}].borderwidth, 1);
                set(hotspot[${hotspotName}].capture, false);
          `);

            krpano.call(
              `set(hotspot[${hotspotName}].onclick, js(handleHotspotClick('${hotspotName}', '${house.plot_number}', '${cords.ath}', '${cords.atv}')));`
            );

            house.coordinates.forEach((point, index) => {
              krpano.call(
                `set(hotspot[${hotspotName}].point[${index}].ath, ${point.ath})`
              );
              krpano.call(
                `set(hotspot[${hotspotName}].point[${index}].atv, ${point.atv})`
              );
            });
          });
        };

        const disappearZoneData = (zoneData, response, krpano) => {
          zoneData.forEach((house) => {
            // Create a unique name for each house hotspot
            const hotspotName = `hs_${house.id}`;

            const hotspotColor = getRandomColor();
            const hotspotColorHex = hotspotColor.replace("#", "0x");
            // Generate hotspot with points dynamically
            let hotspotXML = `<hotspot name="${hotspotName}" style="mypolygonalhotspotstylename">`;

            house.coordinates.forEach((point) => {
              hotspotXML += `<point ath="${point.ath}" atv="${point.atv}" />`;
            });
            hotspotXML += `</hotspot>`;

            const cords = house.coordinates[0];

            krpano.call(`
             
                set(hotspot[${hotspotName}].border, false);
                set(hotspot[${hotspotName}].fillalpha, 0); 
                set(hotspot[${hotspotName}].borderwidth, 0);
          `);

            house.coordinates.forEach((point, index) => {
              krpano.call(
                `set(hotspot[${hotspotName}].point[${index}].ath, ${point.ath})`
              );
              krpano.call(
                `set(hotspot[${hotspotName}].point[${index}].atv, ${point.atv})`
              );
            });
          });
        };

        const blinkOnLoad=() =>{
         
          const params = new URLSearchParams(window.location.search);
        
          const savedHotspot = params.get("hotspot");


        
          console.log("savedHotspot", savedHotspot)
          if(savedHotspot){
            const cleanedhotspotName = savedHotspot.replace(/^hs_/, "");
            blinkIndividualHotspot(cleanedhotspotName, true);

          }
         }
        // Add this new function to your existing JavaScript code (e.g., in the same script block as flyToHouse and showHouseDetails)
        function handleHotspotClick(hotspotName, plotNumber, ath, atv) {
          // First, call your showHouseDetails function
          showHouseDetails( plotNumber);

          localStorage.setItem("selectedHotspot", hotspotName);

          const url = new URL(window.location);
          url.searchParams.set("plotNumber", plotNumber);
         

          url.searchParams.set("hotspot", hotspotName);
          window.history.pushState({}, '', url);

          // Then, call your flyToHouse function
          flyToHouse(ath, atv);
          blinkOnLoad()
          const cleanedhotspotName = hotspotName.replace(/^hs_/, "");

          blinkIndividualHotspot(cleanedhotspotName, true);
            // ✅ Now update the query param in the URL

          


        }

        function flyToHouse(ath, atv) {
          const krpano = document.getElementById("krpanoSWFObject");

          // It's good practice to ensure ath and atv are numbers if krpano expects them as such
          const numericAth = parseFloat(ath);
          const numericAtv = parseFloat(atv);

          if (isNaN(numericAth) || isNaN(numericAtv)) {
            console.error(
              "Invalid ATH or ATV provided to flyToHouse:",
              ath,
              atv
            );
            return;
          }

          const currentFov = krpano.get("view.fov");
          console.log("Current Zoom Level (FOV):", currentFov);

          // Assuming a default FOV and animation speed
          const fov = currentFov; // Or whatever default FOV you need
          const animationSpeed = 0.1; // Smoothness value

          // Use krpano.call to execute the lookto command
          if (krpano) {
            // Always check if krpano object exists

            krpano.call(
              `lookto(${numericAth}, ${numericAtv}, ${fov}, smooth(${animationSpeed}));`
            );

            console.log(
              `Attempting to fly to ATH: ${numericAth}, ATV: ${numericAtv}`
            );
          } else {
            console.error(
              "krpano object not found. Cannot execute flyToHouse."
            );
          }
        }

        const render360Breadcrumbs = () => {
          const krpano = document.getElementById("krpanoSWFObject");
          const currentScene = krpano.get("xml.scene");

          if (String(currentScene).includes("_360")) {
            const alreadyExists = breadcrumbTrail.some((crumb) =>
              crumb.scene.includes("_360")
            );

            if (!alreadyExists) {
              breadcrumbTrail.push({
                scene: currentScene,
                title: "360",
                icon: "grain",
              });

              renderBreadcrumbs();
            }
          }
        };

        const addLandHotspotsToKrpano = async () => {
        
          const krpano = document.getElementById("krpanoSWFObject");
          const response = await onInitalLoad();

          localStorage.setItem("response", JSON.stringify(response));

          let card = document.getElementById("krpano-card");
          
          if (krpano) {
            const currentScene = krpano.get("xml.scene"); // Gets the currently loaded scene name
            const slider = document.getElementById("totalArea");

            if (currentScene === "scene_b-al_marina_aerial" || currentScene === "scene_a-initial" || String(currentScene).includes("_360")) {

             
            if (card) {
              card.remove();
            }
            }
           


            console.log("currentScene", currentScene);

            const icon_360 = document.getElementById("zone_5_360_icon");
            if (icon_360) {
              icon_360.style.display = "block";
            }
            //  render360Breadcrumbs();
            if (currentScene === "scene_b-al_marina_aerial") {
              const alreadyExists = breadcrumbTrail.some(
                (crumb) => crumb.scene === "scene_b-al_marina_aerial"
              );

              if (!alreadyExists) {
                breadcrumbTrail.push({
                  scene: "scene_b-al_marina_aerial",
                  title: "Al Marina",
                  icon: "grain",
                });

                renderBreadcrumbs();
              }
            } else if (currentScene === "scene_c-zone_1") {
              const zone1AlreadyExists = breadcrumbTrail.some(
                (crumb) => crumb.scene === "scene_c-zone_1"
              );
              if (!zone1AlreadyExists) {
                breadcrumbTrail.push({
                  scene: "scene_c-zone_1",
                  title: "Zone 1",
                  icon: "grain",
                });
                renderBreadcrumbs();
                dynamicZoneRendering(zone1houseData, response, krpano);
                updateSliderRange("1");
                slider.value = 17215;
                updateAreaAndSearch(false);
              }

              //onSceneChange(currentScene,unit)
            } else if (currentScene === "scene_d-zone_2") {
              const zone2AlreadyExists = breadcrumbTrail.some(
                (crumb) => crumb.scene === "scene_d-zone_2"
              );
              if (!zone2AlreadyExists) {
                breadcrumbTrail.push({
                  scene: "scene_d-zone_2",
                  title: "Zone 2",
                  icon: "grain",
                });
                renderBreadcrumbs();
                dynamicZoneRendering(zone2houseData, response, krpano);

                slider.value = 2485;
                updateSliderRange("2");
                updateAreaAndSearch(false);
              }
            } else if (currentScene === "scene_e-zone_3") {
              const zone3AlreadyExists = breadcrumbTrail.some(
                (crumb) => crumb.scene === "scene_e-zone_3"
              );
              if (!zone3AlreadyExists) {
                dynamicZoneRendering(zone3houseData, response, krpano);
                breadcrumbTrail.push({
                  scene: "scene_e-zone_3",
                  title: "Zone 3",
                  icon: "grain",
                });
                renderBreadcrumbs();
                slider.value = 2328;
                updateSliderRange("3");
                updateAreaAndSearch(false);
              }
            } else if (currentScene === "scene_l_al_marina_mall_day_aerial") {
              const zone4AlreadyExists = breadcrumbTrail.some(
                (crumb) => crumb.scene === "scene_l_al_marina_mall_day_aerial"
              );
              if (!zone4AlreadyExists) {
                dynamicZoneRendering(zone4houseData, response, krpano);
                breadcrumbTrail.push({
                  scene: "scene_l_al_marina_mall_day_aerial",
                  title: "Zone 4",
                  icon: "grain",
                });
                renderBreadcrumbs();
                slider.value = zoneMaximum;

                updateSliderRange("4");
                updateAreaAndSearch(false);
              }
            } else if (currentScene === "scene_f-zone_4") {
              const zone7AlreadyExists = breadcrumbTrail.some(
                (crumb) => crumb.scene === "scene_f-zone_4"
              );
              if (!zone7AlreadyExists) {
                dynamicZoneRendering(zone7houseData, response, krpano);
                breadcrumbTrail.push({
                  scene: "scene_f-zone_4",
                  title: "Zone 7",
                  icon: "grain",
                });
                renderBreadcrumbs();

                slider.value = 2365;
                updateSliderRange("7");
                updateAreaAndSearch(false);
              }
            } else if (currentScene === "scene_g-zone_5") {
              const zone8AlreadyExists = breadcrumbTrail.some(
                (crumb) => crumb.scene === "scene_g-zone_5"
              );
              if (!zone8AlreadyExists) {
                dynamicZoneRendering(zone8houseData, response, krpano);
                breadcrumbTrail.push({
                  scene: "scene_g-zone_5",
                  title: "Zone 8",
                  icon: "grain",
                });
                const slider = document.getElementById("totalArea");
                slider.value = 4361;

                renderBreadcrumbs();
                updateSliderRange("8");
                updateAreaAndSearch(false);
              }

              // onSceneChange(currentScene,unit)
            } else if (currentScene === "scene_h-building_1") {
              const building1AlreadyExists = breadcrumbTrail.some(
                (crumb) => crumb.scene === "scene_h-building_1"
              );

              if (!building1AlreadyExists) {
                console.log("building1houseData", building1houseData);

                dynamicZoneRendering(building1houseData, response, krpano);
                breadcrumbTrail.push({
                  scene: "scene_h-building_1",
                  title: "Zone 6",
                  icon: "grain",
                });
                slider.value = 15202;
                renderBreadcrumbs();
                updateSliderRange("6");
                updateAreaAndSearch(false);
              }
            } else if (currentScene === "scene_i-building_2") {
              console.log("building2houseData", building2houseData);
              const building2AlreadyExists = breadcrumbTrail.some(
                (crumb) => crumb.scene === "scene_i-building_2"
              );
              if (!building2AlreadyExists) {
                dynamicZoneRendering(building2houseData, response, krpano);
                breadcrumbTrail.push({
                  scene: "scene_i-building_2",
                  title: "Zone 5",
                  icon: "grain",
                });
                slider.value = 6038;
                renderBreadcrumbs();
                updateSliderRange("5");
                updateAreaAndSearch(false);
              }
            }

            //
            else if (currentScene === "scene_k_zone_9") {
              const zone9AlreadyExists = breadcrumbTrail.some(
                (crumb) => crumb.scene === "scene_k_zone_9"
              );
              if (!zone9AlreadyExists) {
                dynamicZoneRendering(zone9houseData, response, krpano);
                breadcrumbTrail.push({
                  scene: "scene_k_zone_9",
                  title: "Zone 9",
                  icon: "grain",
                });
                slider.value = 16038;
                renderBreadcrumbs();
                updateSliderRange("9");
                updateAreaAndSearch(false);
              }
            } else {
              blinkHotspot(false);
            }
          }
        };

        const fetchAlMarinaData = async () => {
          const baseUrl =
            "https://erth-al-marina.zameengeomatics.com/api/getAlMarinaData";

          return fetch(baseUrl)
            .then((res) => res.json())
            .then((data) => {
              return data;
            })
            .catch((err) => console.error("Error fetching data:", err));
        };
        
        // Function to show Bootstrap tooltip

        let cardContainer = document.createElement("div");

        // Media query for mobile portrait
        const portraitQuery = window.matchMedia(
          "(max-width: 768px) and (orientation: portrait)"
        );

        // Media query for mobile and tablet landscape
        const landscapeQuery = window.matchMedia(
          "(max-width: 1024px) and (orientation: landscape)"
        );

        function applyStyles() {
          if (portraitQuery.matches) {
            // Mobile portrait
            // cardContainer.style.top = "195px";
            // cardContainer.style.height = "200px";
            // cardContainer.style.overflowY = "auto";
            cardContainer.style.bottom = ""; // Clear bottom if needed
          } else if (landscapeQuery.matches) {
            // Mobile or tablet in landscape
            // cardContainer.style.bottom = "100px";
            // cardContainer.style.height = "200px";
            // cardContainer.style.overflowY = "auto";
            // cardContainer.style.top = "";
          } else {
            // Other devices / orientations
            // cardContainer.style.top = "195px";
            // cardContainer.style.height = "";
            // cardContainer.style.overflowY = "";
            // cardContainer.style.bottom = "";
          }
        }

        // Initial check
        applyStyles();

        // Listen for changes
        portraitQuery.addListener(applyStyles);
        landscapeQuery.addListener(applyStyles);

        const createCard = (title, description, imageUrl, response) => {
          let unitDetails = {
            zone: response[0].zone,
            plot_number: response[0].plot_number,
            block_number: response[0].block_number,
            total_area: response[0].total_area,
            usage: response[0].usage,
            south: response[0]["الجنوب "],
            west: response[0].west,
            north: response[0].north,
            east: response[0].east,
          };

          console.log("CREATE CARD")

          let existingCard = document.getElementById("krpano-card");
          if (existingCard) {
             existingCard.remove();
          }
          //  <div class="inner_section">

          //  <button class="close-btn">×</button>

          cardContainer.id = "krpano-card";
          cardContainer.innerHTML = `
 <div class="property-card">
   <div class="image-overlay">
   
      <button class="close-btn" onclick="closeCard()">&times;</button>
       
   </div>
   <div class="inner-style">

   <div class="property-info">
       <div class="price-tag"> Price: TBD</div>
        <span>
            <button class="share-btn" onclick="copyAndSharePlot()">
                <i class="fas fa-share"></i> Share
            </button>
   
             <div id="copyTooltip" class="clipboard-tooltip">Link Copied!</div>
        </span>
      <h1 class="heading">Al Marina</h1>
        
      <h2 class="zone_title">
      <i class="fa fa-map-marker mr-2"></i>   
      <span class="display_card_zone">
      ${
        unitDetails.zone.charAt(0).toUpperCase() +
        unitDetails.zone.slice(1).toLowerCase()
      }
        </span>
     
      </h2>
    
      <div class="divider"></div>
      <div class="details_flex">

  <div class="detail-item_flex">
    <span class="label_flex">Area</span>
    <span class="value_flex">${unitDetails.total_area} m²</span>
  </div>
  <div class="detail-item_flex">
    <span class="label_flex">Plot</span>
    <span class="value_flex">${unitDetails.plot_number || "-"}</span>
  </div>
  <div class="detail-item_flex">
    <span class="label_flex">Block</span>
    <span class="value_flex">${unitDetails.block_number || "-"}</span>
  </div>

   <div class="detail-item_flex">
    <span class="label_flex"></span>
    <span class="value_flex"></span>
  </div>
</div>

     
    
         <div class="details-row_extra">
            
            <div class="detail-item">
               <span class="detail-label_1">North</span>
               <span class="detail-value">${unitDetails.north || "-"}</span>
            </div>
            <div class="detail-item">
               <span class="detail-label_1">South</span>
               <span class="detail-value">${unitDetails.south || "-"}</span>
            </div>
            <div class="detail-item">
               <span class="detail-label_1">East</span>
               <span class="detail-value">${unitDetails.east || "-"}</span>
            </div>
            <div class="detail-item">
               <span class="detail-label_1">West</span>
               <span class="detail-value">${unitDetails.west || "-"}</span>
            </div>
         </div>
   
      </div>
   </div>
</div>
`;
          document.body.appendChild(cardContainer);
          const width = window.innerWidth;
          const propertyCard = document.getElementById("krpano-card");

          if (width > 1025) {
            if (propertyCard) {
              console.log("inital load first ");
              propertyCard.style.right = "90px";
              propertyCard.style.top = "12%";
            }
          } else {
            if (propertyCard) {
              propertyCard.style.position = "fixed";
              propertyCard.style.top = "10%";
              propertyCard.style.right = "5%";
            }
          }
        };

        const closeCard = () => {
          blinkIndividualHotspot("", false, false);
          let card = document.getElementById("krpano-card");
          if (card) {
            card.remove();
          }
        };

        const copyAndSharePlot = () => {
          const url = window.location.href;

          navigator.clipboard.writeText(url)
            .then(() => {

              const tooltip = document.getElementById("copyTooltip");
              tooltip.classList.add("show");

              setTimeout(() => {
                tooltip.classList.remove("show");
              }, 2000);
            })
            .catch((err) => {
              console.error("Failed to copy URL: ", err);
            });
        };

        

        const toggleSearchFilter = () => {
          const arrow = document.getElementById("toggleArrow_1");
          const searchBarContainer =
            document.getElementById("searchBarContainer");
          const card = searchBarContainer.querySelector(".card-body");
          const isVisible = card.style.display === "block";
          if (isVisible) {
            card.style.display = "none";
            arrow.textContent = "▶️"; // Collapsed
          } else {
            card.style.display = "block";
            arrow.textContent = "◀️"; // Expanded
          }
        };

        const toggleDetails = () => {
          const arrow = document.getElementById("toggleArrow");

          const details = document.querySelector(".extra-details");
          const btn = document.querySelector(".show-details-button");

          const isHidden =
            details.style.display === "none" || details.style.display === "";
          arrow.textContent = isHidden ? "▲" : "▼";

          if (details.style.display === "block") {
            details.style.display = "none";
          } else {
            details.style.display = "block";
          }
        };

        window.onload = function () {
          const krpano = document.getElementById("krpanoSWFObject");
          if (krpano && krpano.call) {
            console.log("Krpano is ready");
            createSceneCard();
          }
        };

        const showIndividualHouseCard = (house, id) => {
          console.log("id");
          const unitData = localStorage.getItem("response");

          const parsedData = JSON.parse(unitData);

          const filteredData = parsedData?.data?.filter(
            (unit) => unit.plot_number === String(house)
          );

          if (filteredData) {
            createCard(
              "Title",
              "Description",
              "https://via.placeholder.com/150",
              filteredData
            );
            blinkIndividualHotspot(id, true);
          } else {
            console.error("House details not found in the response.");
          }
        };

        // JS workaround for iOS keyboard issues

        // Function to display house details
        const showHouseDetails = ( plot_number) => {
          let card = document.getElementById("krpano-card");
          if (card) {
            card.remove();
          }

          const unitData = localStorage.getItem("response");

          const parsedData = JSON.parse(unitData);

          const filteredData = parsedData?.data?.filter(
            (unit) => unit.plot_number === plot_number
          );

           const image = document.getElementById("mainImage");
          // image.src = "./skin/icons/renders/Al-Marina_Villas.jpg";
          // image.width = 400;

          if (filteredData[0].total_area < 1500) {
            console.log("residential");

            updateImage("residential");

            // Seperate Funciton () resiential image url upate
            // imr src ="./residential_image _render.jpg"
          } else if(filteredData[0].total_area > 2000){
            // imr src ="./palaces.jpg"
            console.log("commercial");
          }else if(filteredData[0].total_area > 1500 && filteredData[0].total_area < 2000  ){
              console.log("palace");
          }

          //   Assuming the first element in the response array corresponds to the clicked house
          if (unitData && unitData.length > 0) {
            blinkOnLoad()
            console.log("After filteredData", filteredData);
           
            createCard(
              "Title",
              "Description",
              "https://via.placeholder.com/150",
              filteredData
            );
          } else {
            console.error("House details not found in the response.");
          }
        };
// let sliderUrl= "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSv94OIn-sX93PJMNosZCYZzXFO8Qk1FB2x3A&s"
let sliderUrl = "./skin/icons/renders/AlMarina_mall.png"

        function updateImage(type) {
          const image = document.getElementById("mainImage");
          if (type === "residential") {
            sliderUrl = "./skin/icons/renders/Al_Marina_Villa-1.png"
            //image.src = "./skin/icons/renders/Al-Marina_Villas.jpg";
          } else if (type === "palaces") {
           sliderUrl = "./skin/icons/renders/Al_Marina_Palaces-1.png"
          } else{
            sliderUrl = "./skin/icons/renders/Al_Marina_mall.png"
          }
        }

        
// function updateImage(type) {
//   const card = document.querySelector(".property-card"); // or use an ID or loop through multiple
//   let sliderUrl;

//   if (type === "residential") {
//     sliderUrl = "url('./skin/icons/renders/Al_Marina_Villa-1.png')";
//   } else if (type === "palaces") {
//     sliderUrl = "url('./skin/icons/renders/Al_Marina_Palaces-1.png')";
//   } else {
//     sliderUrl = "url('./skin/icons/renders/Al_Marina_mall.png')";
//   }

//   card.style.setProperty('--bg-image-url', sliderUrl);
// }



        let sliderDynamicImageURL = ""


           function dynamicSliderImage(area) {
            if (area < 1500) {
            console.log("residential");
          sliderDynamicImageURL = "./skin/icons/renders/Al_Marina_Villa.png"
         

          } else if(area > 2000){
           
            console.log("commercial");
            sliderDynamicImageURL = "./skin/icons/renders/AlMarina_mall.png"
          }else if(area > 1500 && area < 2000  ){
              console.log("palace");
              sliderDynamicImageURL = "./skin/icons/renders/Al_Marina_Palaces.png"
          }
          return sliderDynamicImageURL;
         
        }



        const showTooltip = (hotspotName, houseId, cords) => {
          // Convert string back to an array

          // blinkHotspot(hotspotName)
          const coordinatesString = cords;
          const coordinatesArray = coordinatesString.split(",").map(Number);
          const krpano = document.getElementById("krpanoSWFObject");

          let existingTooltip = document.getElementById("hotspot-tooltip");
          if (existingTooltip) {
            existingTooltip.remove(); // Remove existing tooltip if it exists
          }

          if (!krpano || !krpano.get) {
            console.error("Krpano is not ready yet.");
            return;
          }
          // Convert hotspot position to screen coordinates

          const tooltip = document.createElement("div");
          tooltip.id = "hotspot-tooltip";
          tooltip.className = "tooltip bs-tooltip-top show"; // Bootstrap tooltip classes
          tooltip.setAttribute("role", "tooltip");

          // Tooltip inner content
          tooltip.innerHTML = `
				<div class="tooltip-arrow"></div>
				  <div class="tooltip-inner">
				  🏠 Plot: ${houseId} <br> Click for details
				  </div>
			  `;

          // Apply Bootstrap styles
          tooltip.style.position = "absolute";

          tooltip.style.top = "500px"; // Adjust as necessary
          tooltip.style.left = "50%";

          // tooltip.style.top = `${y}px`;
          // tooltip.style.left = `${x}px`;
          tooltip.style.transform = "translateX(-50%)";
          tooltip.style.zIndex = "1000";

          document.body.appendChild(tooltip);

          // Remove the tooltip after 3 seconds
          setTimeout(() => {
            tooltip.remove();
          }, 3000);
        };
        // Function to hide the tooltip when the mouse leaves
        const hideTooltip = () => {
          let existingTooltip = document.getElementById("hotspot-tooltip");
          if (existingTooltip) {
            existingTooltip.remove();
          }
        };

        // Zoom in function
        const zoomIn = () => {
          const krpano = document.getElementById("krpanoSWFObject");

          krpano.call("set(fov_moveforce,-1);");
        };

        const zoomOut = () => {
          const krpano = document.getElementById("krpanoSWFObject");

          krpano.call("set(fov_moveforce,+1);");
          // Wait briefly to ensure the scene is ready, then zoom
        };

        function checkSceneAndToggle() {
          const krpano = document.getElementById("krpanoSWFObject");

          // Assuming krpano is available globally
          const currentScene = krpano.get("xml.scene");

          const fullScreenBtn = document.getElementById("fullScreenBtn");

          const toggleButton = document.getElementById("toggle-button");
          const mobileSearchCard =
            document.getElementById("mobileSearchFilter");
          const searchSliderFilters = document.getElementById(
            "searchSliderFilters"
          );
          const mobileSearchFilter =
            document.getElementById("mobileSearchFilter");
          const searchBar = document.getElementById("searchBarContainer");
          //toggle-button

          if (
            currentScene === "scene_a-initial" ||
            currentScene === "scene_b-al_marina_aerial" ||
            currentScene === "scene_13-180m" ||
            currentScene === "future_scene_13-180m"
          ) {
            searchBar.hidden = true;
          } else if (currentScene && currentScene !== "scene_1_360") {
            searchBar.hidden = false;
          }
          if (currentScene === "scene_a-initial") {
            // searchBar.hidden = true;
            // fullScreenBtn.style.display = "none";
            // toggleButton.style.display = "none";
          } else {
            //fullScreenBtn.style.display = "block";
            toggleButton.style.display = "block";
            //
          }

          updateToggleMarginBasedOnSlider();

          const toggle = document.getElementById("time-toggle");
          const toggleLayerWrapper = document.getElementById(
            "toggle_layer_wrapper"
          );

          if (
            String(currentScene).includes("_360") ||
            currentScene === "scene_13-180m" ||
            currentScene === "future_scene_13-180m"
          ) {
            toggle.style.display = "block";
            toggleLayerWrapper.style.display = "none";
          } else {
            toggle.style.display = "none";
            toggleLayerWrapper.style.display = "flex";
          }
        }

        const enableZoomControls = () => {
          // document
          //   .getElementById("zoomInBtn")
          //   .addEventListener("click", function () {
          //     zoomIn();
          //   });

          // document
          //   .getElementById("zoomOutBtn")
          //   .addEventListener("click", function () {
          //     zoomOut();
          //   });

          document
            .getElementById("fullScreenBtn")
            .addEventListener("click", function () {
              toggleFullScreen();
            });
        };

        function handleOrientation() {}

      
      window.onload = () => {
          let krpano = globalKrpano();
          const currentScene = krpano.get("xml.scene"); // Gets the currently loaded scene name
           

          if (!sessionStorage.getItem("reloaded")) {
            sessionStorage.setItem("reloaded", "true");
            location.reload();
          } else {
            sessionStorage.removeItem("reloaded");
          }

          const params = new URLSearchParams(window.location.search);
          const scene = params.get("zone");
          const plotNumber = params.get("plotNumber");


  
          if (currentScene !== "scene_b-al_marina_aerial" || currentScene !== "scene_a-initial" ) {
         
            console.log("HERE IT IS ")
            plotNumber && showHouseDetails(plotNumber)
          }
         

          
          if (params.size && scene)   {

     

            breadcrumbTrail.push({
                  scene: "scene_b-al_marina_aerial",
                  title: "Al Marina",
                  icon: "grain",
                });

            // Wait until krpano is ready, then load the scene
            const krpano = document.getElementById("krpanoSWFObject");

            if (krpano && krpano.call) {
              console.log("FIRST IF");
              krpano.call(`loadscene(${scene}, null, MERGE, BLEND(1));`);
            
              // createCard
            } else {
              console.error("krpano object not found or not ready");
            }
          } else {
           // krpano.call("loadscene(scene_a-initial, null, MERGE);");
          }


          //scene_g-zone_5   scene_a-initial
          //   krpano.call("loadscene(scene_a-initial, null, MERGE);");

          if (krpano) {
            console.log("Krpano Initialized ");

            const animationSpeed = 0.1;
          }

          setTimeout(() => {
            if (typeof krpano !== "undefined" && krpano !== null) {
              console.log("setTimeout Krpano Initialized");
               //onInitalLoad();
          //   showHouseDetails(plotNumber)
            }
          }, 3000);

          const mobileSearchCard =
            document.getElementById("mobileSearchFilter");

          const searchSliderFilters = document.getElementById(
            "searchSliderFilters"
          );
          const mobileSearchFilter =
            document.getElementById("mobileSearchFilter");

          addCustomDivToHotspot("hs1");

          // Delay to ensure Krpano loads
          updateSearchVisibility();
          showSearchFilterCardsMobile();
          displayHorizontalSlider();
          flyToInitialAlMarinaScene();

          const unit = getSpecificUnit();

          // onSceneChange(currentScene, unit)

          krpano.set("events.onnewscene", "js(checkSceneAndToggle());");
          checkSceneAndToggle(); // initial check

          if (typeof krpano !== "undefined" && krpano !== null) {
            // or however your app provides scene name

            krpano.set(
              "events.onloadcomplete",
              "js(enableZoomControls()); js(addLandHotspotsToKrpano()); js(updateSearchVisibility());  js(displayHorizontalSlider()); js(createSceneCard()); js(showSearchFilterCardsMobile);js(flyToInitialAlMarinaScene);) "
            );
          }
        };
      </script>
    </div>
  </body>
</html>
